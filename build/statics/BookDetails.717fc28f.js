var ve=Object.defineProperty,xe=Object.defineProperties;var we=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable;var de=(a,t,s)=>t in a?ve(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s,T=(a,t)=>{for(var s in t||(t={}))me.call(t,s)&&de(a,s,t[s]);if(H)for(var s of H(t))pe.call(t,s)&&de(a,s,t[s]);return a},x=(a,t)=>xe(a,we(t));var V=(a,t)=>{var s={};for(var o in a)me.call(a,o)&&t.indexOf(o)<0&&(s[o]=a[o]);if(a!=null&&H)for(var o of H(a))t.indexOf(o)<0&&pe.call(a,o)&&(s[o]=a[o]);return s};import{R as e,r as u,fm as he,aj as f,hO as Me,aS as A,aG as te,ak as Fe,g2 as W,eX as _,aH as z,aI as ae,hP as j,eC as ge,cw as be,hQ as De,bj as Be,b8 as Re,hR as Pe,hS as Ge,hT as $e,c$ as G,d0 as D,ci as ee,cc as Ue,eq as Q,fC as ze,aJ as Z,ct as He,ga as Ve,gb as Ke,eZ as Ye,cZ as Y,eO as _e,eP as We,d3 as se,hU as je,eS as J,hV as K,eN as qe,fn as Je,ai as ne,eL as Qe,d6 as fe,d7 as Ze,d9 as Xe,eV as et}from"./index.7daee9ef.js";import{u as tt,B as at}from"./useBookMutation.1b588b31.js";import{w as M,v as N,r as O,u as F,x as k,y as $,z as Le,K as st,B as ue,C as nt}from"./useShowSnackbar.da46e481.js";import{i as w}from"./infer-query.264ca744.js";import{s as oe,a as ot}from"./display-order.ffc5e670.js";import{u as rt}from"./useBasicContent.160dc809.js";import{t as ct,u as it,D as lt,A as Se,a as ye,b as re,d as dt,c as mt}from"./useSwapOrder.3f124831.js";import{I as B}from"./IconButtonBase.a835a6a3.js";import{u as Ce}from"./useNotifyForm.ee77e08e.js";import{A as pt}from"./AvatarInputHF.36ed1c41.js";import{u as ce}from"./useNavigation.f38e637f.js";import{E as ut,a as Et}from"./EntityIcon.4e674647.js";import{u as ht}from"./useDeleteTaskAssignment.3c85a286.js";import{u as gt}from"./useDeleteAssignment.cd19c3d4.js";import{a as Te,b as q,A as Ae}from"./AccordionSummaryBase.51fee70a.js";import{u as bt}from"./useDialog.8ab3e0e0.js";const Ee=a=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg","data-testid":"LOIcon__svg",width:"20",height:"20",fill:"none",viewBox:"0 0 20 20"},e.createElement("path",{fill:"#fff",d:"M11.849 7.088a.348.348 0 000-.575l-2.695-1.85a.353.353 0 00-.553.287v3.7c0 .282.32.448.553.287l2.695-1.85z"}),e.createElement("path",{fill:"#fff",fillRule:"evenodd",d:"M2.8 2.8a1.6 1.6 0 011.6-1.6h11.2a1.6 1.6 0 011.6 1.6v14.4a1.6 1.6 0 01-1.6 1.6H4.4a1.6 1.6 0 01-1.6-1.6V2.8zm2.4 9.6a.8.8 0 01.8-.8h8a.8.8 0 010 1.6H6a.8.8 0 01-.8-.8zM8 14.8a.8.8 0 000 1.6h4a.8.8 0 000-1.6H8zm-2.8-10a1.2 1.2 0 011.2-1.2h7.2a1.2 1.2 0 011.2 1.2v4a1.2 1.2 0 01-1.2 1.2H6.4a1.2 1.2 0 01-1.2-1.2v-4z",clipRule:"evenodd"})),_t=a=>e.createElement("svg",{"data-testid":"FlashCardIcon__svg",xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",fill:"none",viewBox:"0 0 22 22"},e.createElement("path",{fill:"#fff",fillRule:"evenodd",d:"M1.27 4.926a1.355 1.355 0 011.114-1.56l9.427-1.662a1.355 1.355 0 011.58 1.085l2.098 11.9c.129.73-.37 1.429-1.113 1.56L4.948 17.91a1.355 1.355 0 01-1.58-1.085L1.27 4.926zm8.41 6.238l-2.153.38-.226 1.059-1.469.259 1.35-5.487 1.418-.25 3.152 4.693-1.498.264-.575-.918zm-.61-.988L8.13 8.663l-.368 1.744 1.31-.23zm8.02 10.552l-9.334-1.646 8.162-1.439c.942-.166 1.578-1.024 1.42-1.917l-1.81-10.27 4.126.727c.744.131 1.242.83 1.114 1.56l-2.099 11.9a1.355 1.355 0 01-1.58 1.085z",clipRule:"evenodd"})),ft=a=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",fill:"none",viewBox:"0 0 20 20","data-testid":"AssignmentIcon__svg"},e.createElement("path",{fill:"#fff",fillRule:"evenodd",d:"M3.183 2.4c-.764 0-1.382.62-1.382 1.382V16.22c0 .763.618 1.381 1.382 1.381h9.672c.763 0 1.382-.618 1.382-1.381V3.782c0-.763-.619-1.382-1.382-1.382H3.183zm1.381 3.455a.69.69 0 000 1.382h6.91a.69.69 0 100-1.382h-6.91zM3.874 10c0-.381.309-.69.69-.69h6.91a.69.69 0 110 1.381h-6.91a.69.69 0 01-.69-.69zm.69 2.764a.69.69 0 100 1.382h2.764a.69.69 0 100-1.382H4.564z",clipRule:"evenodd"}),e.createElement("path",{fill:"#fff",d:"M15.7 3.438c-.276 0-.5-.22-.499-.492v-.047a.5.5 0 01.502-.495l1.999-.004c.277 0 .5.221.5.494l-.001.047a.5.5 0 01-.501.493l-2 .004zM15.222 4.92a.5.5 0 01.5-.495h1.98c.276 0 .5.221.499.494v5.641c0 .13-.054.256-.147.348l-.959.947a.505.505 0 01-.707.002l-1.02-1.008a.488.488 0 01-.146-.349V4.92z"})),Lt=a=>e.createElement("svg",{"data-testid":"OfflineStudyIcon__svg",xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",fill:"none",viewBox:"0 0 22 22"},e.createElement("path",{fill:"#fff",fillRule:"evenodd",d:"M19.232 12.517a8.233 8.233 0 11-16.466 0 8.233 8.233 0 0116.466 0zm-1.733 0a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0zm-1.3 0a5.2 5.2 0 11-10.4 0 5.2 5.2 0 0110.4 0zm-2.312-2.994l-2.664 1.235a1.173 1.173 0 101.584 1.496l1.08-2.73z",clipRule:"evenodd"}),e.createElement("path",{fill:"#fff",fillRule:"evenodd",d:"M8.617 1.25a.867.867 0 100 1.733h4.766a.867.867 0 100-1.733H8.617zm4.116 1.733H9.267v.867h3.466v-.867z",clipRule:"evenodd"}),e.createElement("path",{fill:"#fff",d:"M15.827 4.08a.867.867 0 011.221-.107l1.328 1.114a.867.867 0 01.107 1.221l-.279.332-2.655-2.228.278-.332zM6.196 4.08a.867.867 0 00-1.22-.107L3.646 5.087a.867.867 0 00-.106 1.221l.278.332 2.656-2.228-.279-.332z"})),St=a=>e.createElement("svg",{width:"32",height:"33",viewBox:"0 0 32 33",fill:"none",xmlns:"http://www.w3.org/2000/svg","data-testid":"TaskAssignmentIcon__svg"},e.createElement("path",{d:"M0 16.3281C0 7.49157 7.16344 0.328125 16 0.328125C24.8366 0.328125 32 7.49157 32 16.3281C32 25.1647 24.8366 32.3281 16 32.3281C7.16344 32.3281 0 25.1647 0 16.3281Z",fill:"#2196F3"}),e.createElement("g",{clipPath:"url(#clip0_25670_112351)"},e.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M8.80078 10.3268C8.79945 9.22215 9.69388 8.32562 10.7985 8.32436L21.1985 8.3125C22.303 8.31124 23.1994 9.20557 23.2008 10.3101L23.2153 22.3101C23.2166 23.4147 22.3222 24.3112 21.2175 24.3125L10.8176 24.3244C9.71303 24.3256 8.8166 23.4313 8.81527 22.3268L8.80078 10.3268ZM10.4003 9.94019L21.6003 9.92764L21.6158 22.7276L10.4158 22.7402L10.4003 9.94019ZM12.0003 11.5267H20.0003V16.3267H12.0003V11.5267ZM17.4003 13.9267L14.7003 15.5267V12.3267L17.4003 13.9267ZM12.0003 17.1267H20.0003V18.7267H12.0003V17.1267ZM18.4003 19.5267H13.6003V21.1267H18.4003V19.5267Z",fill:"white"})),e.createElement("defs",null,e.createElement("clipPath",{id:"clip0_25670_112351"},e.createElement("rect",{width:"19.2",height:"19.2",fill:"white",transform:"translate(6.40039 6.72656)"})))),yt=a=>{const n=w({entity:"book",action:"BOOK_GET_ONE"})({book_id:a},{enabled:!0}),{data:t}=n,s=V(n,["data"]),o=u.exports.useMemo(()=>t&&t.book_chapters?t.book_chapters.map(l=>l.chapter_id):[],[t]);return T({chapterIds:o},s)},ie=({bookId:a})=>{const{school_id:t}=rt(),{mutate:s,isLoading:o}=M({entity:"chapter",action:"syllabusChapterUpsert"})({syllabusMigrationQuery:"default"}),n=u.exports.useCallback((r,m)=>{const E=(p=>p?{chapterId:p.chapter_id,chapterName:p.name,schoolId:p.school_id,displayOrder:p.display_order}:{})(m);return{bookId:a,chaptersList:[x(T({chapterId:he(),schoolId:t,displayOrder:0},E),{chapterName:r.name})]}},[a,t]),l=u.exports.useCallback(r=>{let m=r;return r.length>=2&&(m=oe(r[0],r[1])),{bookId:a,chaptersList:m.map(d=>{var E;return{chapterId:d.chapter_id,chapterName:d.name,schoolId:d.school_id,displayOrder:(E=d.display_order)!=null?E:1}})}},[a]),c=u.exports.useCallback(({formData:r,chapter:m},d)=>{const E=n(r,m);s(E,d)},[n,s]),i=u.exports.useCallback((r,m)=>{const d=l(r);s(d,m)},[l,s]);return{upsertChapter:c,updateOrder:i,isLoading:o}},Ct=a=>{const c=a,{children:t,overlayContent:s,mode:o="unset",open:n}=c,l=V(c,["children","overlayContent","mode","open"]);return e.createElement(f,{position:"relative"},o==="absolute"?e.createElement(Me,x(T({},l),{open:n,sx:i=>({position:"absolute",width:"100%",height:"100%",backgroundColor:i.palette.common.white})}),s):n&&e.createElement(f,null,s),e.createElement(f,{display:n?"none":"unset"},t))},Tt=a=>{const{onSuccess:t}=a,s=N(),o=O();return M({entity:"chapter",action:"syllabusChapterDelete"})({syllabusMigrationQuery:"default",onSuccess:()=>{s(o("ra.common.deleteSuccess",{smart_count:o(`resources.${A.CHAPTERS}.chapter`)},{lowercase:!0})),t()}})},Oe=a=>{const t=O(),{open:s,onClose:o,onOpen:n,disableSubmit:l}=a;return e.createElement(f,{borderRadius:1,borderColor:"primary","data-testid":"ChapterForm__root",sx:c=>{var i;return{display:"flex",alignItems:"center",padding:c.spacing(.875,2.5),border:`1px solid ${(i=c.palette.border)==null?void 0:i.main}`}}},e.createElement(f,{display:"flex",justifyContent:"space",width:"100%"},s&&e.createElement(te,{required:!0,name:"name",size:"small",rules:{required:{value:!0,message:t("resources.input.error.required")}},label:t("resources.chapters.chapterName")}),s?e.createElement(f,{display:"flex",pl:5,height:36},e.createElement(Fe,{"data-testid":"ChapterForm__cancel",color:"default",variant:"text",onClick:o},t("ra.action.cancel")),e.createElement(f,{display:"flex",pl:3},e.createElement(W,{disabled:l,"data-testid":"ChapterForm__submit",type:"submit"},t("ra.action.save")))):e.createElement(W,{color:"primary",disableElevation:!0,disableFocusRipple:!0,variant:"text",onClick:n,"data-testid":"ChapterForm__visibleFormControl"},t("resources.chapters.addTitle"))))},At=a=>{const{bookId:t,chapter:s,onClose:o,refetch:n}=a,l=F(A.CHAPTERS),c=Ce({action:_.EDIT,entityName:l("chapter")}),{upsertChapter:i,isLoading:r}=ie({bookId:t}),m=z({defaultValues:T({},s)}),{handleSubmit:d}=m,E=p=>{i({formData:p,chapter:s},{onSuccess:()=>{c(j.SUCCESS,{}),n()},onError:()=>{c(j.FAILURE,{})}})};return e.createElement(ae,{methods:m,formProps:{onSubmit:d(E),role:"EditChapter__form",style:{width:"100%"}}},e.createElement(Oe,{disableSubmit:r,open:!0,onClose:o}))},Ie=()=>{const a=u.exports.useCallback(({name:c,files:i},r)=>x(T({},r),{chapterId:r.chapter_id,displayOrder:r.display_order,schoolId:r.school_id,name:c,files:i?[...i]:[]}),[]),t=u.exports.useCallback(c=>oe(c[0],c[1]).map(i=>x(T({},i),{chapterId:i.chapter_id,displayOrder:i.display_order,schoolId:i.school_id,files:[]})),[]),{mutate:s,isLoading:o}=M({entity:"topic",action:"syllabusTopicUpsert"})({syllabusMigrationQuery:"default"}),n=u.exports.useCallback(({formData:c,topic:i},r)=>{const m=a(c,i);s(m,r)},[a,s]),l=u.exports.useCallback((c,i)=>{const r=t(c);s(r,i)},[t,s]);return{updateTopic:n,isLoading:o,updateOrder:l}},Ot=()=>{const a=N(),t=O(),{mutate:s,isLoading:o}=M({entity:"topic",action:"syllabusTopicUpsert"})({syllabusMigrationQuery:"default",onSuccess:()=>{a(t("ra.common.addedSuccess",{smart_count:t("resources.topics.name")},{lowercase:!0}))},onError:c=>{k.warn("[Create topic]",c),a(t("ra.common.createdFail"),ge.ERROR)}}),n=u.exports.useCallback(({name:c,files:i},r)=>{const{chapter_id:m,school_id:d}=r;return{schoolId:d,chapterId:m,topic_id:he(),name:c,files:i?[...i]:[],displayOrder:0}},[]);return{createTopic:u.exports.useCallback(({formData:c,chapter:i},r)=>{const m=n(c,i);s(m,r)},[n,s]),isLoading:o}},Ne=()=>{const a=O();return e.createElement(f,{"data-testid":"TopicForm__root"},e.createElement(f,{display:"flex",justifyContent:"center",mb:2},e.createElement(pt,{name:"files",initialSource:"icon_url",mode:"files"})),e.createElement(te,{name:"name",label:a("resources.topics.topicName"),required:!0,rules:{required:a("resources.input.error.required")}}))},It=({chapter:a,refetch:t,open:s,onClose:o})=>{const n=F(A.TOPICS),l=z(),{handleSubmit:c,reset:i}=l,{createTopic:r,isLoading:m}=Ot(),d=()=>{i({name:"",files:void 0}),o()},E=p=>{r({formData:p,chapter:a},{onSuccess:()=>{t(),d()}})};return e.createElement(be,{open:s,methods:l,title:n("AddTopicDialogHeader"),"data-testid":"DialogCreateTopic__root",onClose:o,onSave:c(E),shouldPressKey:!0,footerConfirmButtonProps:{disabled:m}},e.createElement(Ne,null))},Nt=({onSuccess:a})=>{const t=O(),s=N(),{mutate:o,isLoading:n}=M({entity:"topic",action:"syllabusTopicDelete"})({syllabusMigrationQuery:"default",onSuccess:()=>{s(t("ra.common.deleteSuccess",{smart_count:t("resources.topics.name")},{lowercase:!0})),a&&a()},onError:l=>{k.warn("[useDeleteTopic] TOPIC delete",l),s(t("ra.common.deleteFail"),"error")}});return{deleteTopic:o,isLoading:n}},kt=({open:a,topic:t,onClose:s,onSuccess:o})=>{const n=F(A.TOPICS),l=O(),c=N(),i=z({defaultValues:T({},t)}),{handleSubmit:r,reset:m}=i,{updateTopic:d,isLoading:E}=Ie(),p=h=>{d({formData:h,topic:t},{onSuccess:()=>{c(l("ra.common.updatedSuccess",{smart_count:n("name")},{lowercase:!0})),o(),s()},onError:()=>{c(`${l("ra.common.updatedFail")}}`,ge.ERROR)}})};return u.exports.useEffect(()=>{a&&m(T({},t))},[a,m,t]),e.createElement(be,{methods:i,title:n("editTitle"),open:a,onClose:s,onSave:r(p),footerConfirmButtonProps:{disabled:E}},e.createElement(Ne,null))},vt=a=>({id:`nav-tab-${a}`,"aria-controls":`nav-tabpanel-${a}`,"data-testid":"Tab",key:a}),xt=48,wt=a=>{const c=a,{mapTabs:t}=c,s=V(c,["mapTabs"]),{currentTab:o,handleChangeCurrentTabForTabBase:n}=De(),l=Be();return e.createElement(Re,x(T({},s),{additionalHeights:Number(l.spacing(2).slice(0,2))+xt,header:e.createElement(Pe,x(T({},s),{disableBottomPadding:!0}),e.createElement(f,{pt:2},e.createElement(Ge,{value:o,onChange:n,indicatorColor:"primary",textColor:"primary"},t.map((i,r)=>u.exports.cloneElement(i.tabName,T({},vt(r)))))))}),t.map((i,r)=>e.createElement($e,{index:r,value:o,key:r},i.tabPanel)))},Mt=()=>{const{isEnabled:a}=$(G.FLASHCARD_MANAGEMENT),{isEnabled:t}=$(G.ASSIGNMENT_MANAGEMENT),{isEnabled:s}=$(G.EXAM_LO_MANAGEMENT),{isEnabled:o}=$(G.OFFLINE_STUDY_MANAGEMENT),{isEnabled:n}=$(G.TASK_ASSIGNMENT_MANAGEMENT);return{configKeys:u.exports.useMemo(()=>({LO:!0,FLASH_CARD:a,ASSIGNMENT:t,EXAM_LO:s,OFFLINE_STUDY:o,TASK_ASSIGNMENT:n}),[a,t,s,o,n])}},Ft=a=>{const{topicId:t}=a,s=O(),o=N(),{data:n,isLoading:l}=w({entity:"topic",action:"syllabusTopicGetOne"})({topic_id:t},{enabled:Boolean(t)}),{mutate:c,isLoading:i}=M({entity:"learningObjective",action:"syllabusLOUpsert"})({syllabusMigrationQuery:"default"}),r=u.exports.useCallback(d=>d.type==="ASSIGNMENT"||d.type==="TASK_ASSIGNMENT"||!n?null:{name:d.name,type:d.type,topicId:n.topic_id,schoolId:n.school_id,displayOrder:0},[n]),m=u.exports.useCallback((d,E)=>{if(i)return;const p=r(d);if(!p){o(s("ra.common.someThingWentWrong"),"error");return}c(p,E)},[i,r,c,o,s]);return{isLoading:i,isPrepareLoading:l,createLOs:m}},U={ASSIGNMENT:"ASSIGNMENT",LO:"LEARNING_OBJECTIVE_TYPE_LEARNING",FLASH_CARD:"LEARNING_OBJECTIVE_TYPE_FLASH_CARD",OFFLINE_STUDY:"LEARNING_OBJECTIVE_TYPE_OFFLINE_LEARNING",EXAM_LO:"LEARNING_OBJECTIVE_TYPE_EXAM_LO",TASK_ASSIGNMENT:"TASK_ASSIGNMENT"},Dt=({topicId:a,searchURL:t,onClose:s})=>{const o=O(),n=ce(),{createLOs:l,isLoading:c,isPrepareLoading:i}=Ft({topicId:a}),r=F(A.LOS),{configKeys:m}=Mt(),d=z(),{handleSubmit:E}=d,p=Ce({entityName:r("shortenName"),action:_.CREATE,shouldLowercase:!1}),[h,L]=u.exports.useState(),g=u.exports.useCallback(I=>{L(I.target.value)},[]),b=u.exports.useCallback(I=>{l(I,{onSuccess:({loIdsList:P})=>{n.push(`/${D.SYLLABUS}/${A.LOS}/${P[0]}/show${t}`),p(j.SUCCESS,{},"")},onError:P=>{k.warn("[LOs create]",P),p(j.FAILURE,{},P.message)}})},[l,n,p,t]),S=u.exports.useCallback(()=>{const I=`/${D.SYLLABUS}/${ee.ASSIGNMENTS}/create${t}`;n.push(I)},[n,t]),y=u.exports.useCallback(()=>{const I=`/${D.SYLLABUS}/${ee.TASK_ASSIGNMENTS}/create${t}`;n.push(I)},[n,t]),C=u.exports.useCallback(I=>{switch(h){case U.ASSIGNMENT:S();break;case U.TASK_ASSIGNMENT:y();break;default:b(I);break}},[h,S,y,b]),v=u.exports.useMemo(()=>{let I={};for(const[le,ke]of Object.entries(m))ke&&(I[le]=U[le]);return ct(Ue(I,"LearningObjectiveType",A.LOS),o)},[m,o]),R=u.exports.useMemo(()=>h&&![U.ASSIGNMENT,U.TASK_ASSIGNMENT].includes(h),[h]);return i?e.createElement(f,{"data-testid":"CreateLOsTab__prepareLoading"},e.createElement(Q,{height:32}),e.createElement(Q,{height:84}),e.createElement(Q,{height:64})):e.createElement("div",{"data-testid":"CreateLOsTab__root"},e.createElement(ae,{methods:d,formProps:{onSubmit:E(C)},shouldPressKey:!0},e.createElement(ze,null,e.createElement(f,{pt:1},e.createElement(Z,{container:!0,spacing:3},e.createElement(Z,{item:!0,xs:4},e.createElement(He,{label:r("placeholder.selectLOsType"),required:!0,rules:{required:{value:!0,message:o("resources.input.error.required")}},name:"type",options:v,onChange:g})),e.createElement(Z,{item:!0,xs:8},R&&e.createElement(te,{required:!0,label:r("placeholder.loName"),name:"name",rules:{required:o("resources.input.error.required")}})))))),e.createElement(Ve,null,e.createElement(Ke,{onSave:E(C),onClose:s,textSave:o("ra.action.confirm"),footerConfirmButtonProps:{disabled:c}})))},Bt=a=>{const{open:t,onClose:s,searchURL:o,topicId:n}=a,l=F(A.LOS),c=u.exports.useMemo(()=>[{tabName:e.createElement(Ye,{label:l("addNew")}),tabPanel:e.createElement(Dt,{topicId:n,onClose:s,searchURL:o})}],[s,o,l,n]);return e.createElement(wt,{title:`${l("addLearningObjective")}`,maxWidth:"lg",minWidthBox:"md",open:t,onClose:s,footer:"portal",mapTabs:c,"data-testid":"DialogLOs__root"})},Rt=a=>{const t=N(),s=O(),{mutate:o,isLoading:n}=M({entity:"learningObjective",action:"LO_ASSIGNMENT_UPDATE_DISPLAY_ORDER"})({syllabusMigrationQuery:"default"}),l=u.exports.useCallback(i=>oe(i[0],i[1]),[]);return{updateOrder:u.exports.useCallback(async(i,{onSuccess:r})=>{const m=l(i),d=[],E=[];m.forEach(p=>{const{display_order:h}=p,L=h!=null?h:1;if(Le(p)){const b=p;d.push({displayOrder:L,loId:b.lo_id,topicId:a});return}const g=p;E.push({displayOrder:L,assignmentId:g.assignment_id,topicId:a})}),o({learningObjectivesList:d,assignmentsList:E},{onSuccess:()=>{t(s("ra.message.moveSuccess")),r&&r()},onError:p=>{k.warn("[useReOrderLOAndAssignment]",p),t(`${s("ra.message.moveFail")}: ${s(p.message)}`,"error")}})},[l,o,a,t,s]),isLoading:n}},Pt=a=>{const{entity:t}=a,{deleteLOs:s,isLoading:o}=it(),{deleteAssignment:n,isLoading:l}=gt(),{deleteTaskAssignment:c,isLoading:i}=ht();return{deleteLOsAndAssignment:u.exports.useCallback((m,d)=>{if(t===A.LOS)return s({loIdsList:Y(m)},d);if(t===ee.TASK_ASSIGNMENTS)return c({assignmentIdsList:Y(m)},d);n({assignmentIdsList:Y(m)},d)},[n,s,c,t]),isLoading:o||l||i}},Gt=a=>{if(!a)return Ee;switch(a){case K.LEARNING_OBJECTIVE_TYPE_FLASH_CARD:return _t;case K.LEARNING_OBJECTIVE_TYPE_OFFLINE_LEARNING:return Lt;case K.LEARNING_OBJECTIVE_TYPE_LEARNING:return Ee;case K.LEARNING_OBJECTIVE_TYPE_EXAM_LO:return Et;case st.ASSIGNMENT_TYPE_TASK:return St;default:return ft}},$t=a=>{const{topicId:t,data:s,onSuccess:o,onReOrder:n,isLO:l,disabledDown:c,disabledUp:i,itemId:r,searchUrl:m,resource:d}=a,{name:E,type:p}=s,h=Gt(p||void 0),L=`/${D.SYLLABUS}/${d}/${r}/show${m}`,{push:g}=ce(),[b,S]=u.exports.useState(!1),{deleteLOsAndAssignment:y,isLoading:C}=Pt({entity:d}),v=u.exports.useCallback(R=>{switch(R){case _.RENAME:return l?S(!0):g({pathname:`/${D.SYLLABUS}/${d}/${r}/edit`,search:`${m}`});case _.DELETE:return y(r,{onSuccess:o})}},[y,r,l,o,g,d,m]);return e.createElement(e.Fragment,null,l&&e.createElement(lt,{open:b,topicId:t,data:s,onClose:()=>S(!1),onSuccess:o}),e.createElement(_e,{key:r,disableRipple:!0,button:!0,"data-testid":"LOAndAssignmentItem__root","data-value":r,onClick:()=>g(L)},e.createElement(f,{mr:-1},e.createElement(ut,null,e.createElement(h,null))),e.createElement(f,{pl:1},e.createElement(We,{"data-testid":"LOAndAssignmentItem__name",primary:e.createElement(se,{variant:"body2",color:"primary",maxLength:60},E)})),e.createElement(je,{sx:R=>({right:R.spacing(.5)})},e.createElement(f,{display:"flex",alignItems:"center",gap:1},e.createElement(B,{size:"large",sx:{width:40,height:40},color:"primary",disabled:c,onClick:()=>n(_.MOVE_DOWN,r),"data-testid":"LOAndAssignmentItem__moveDown"},e.createElement(Se,{fontSize:"small"})),e.createElement(B,{size:"large",sx:{width:40,height:40},color:"primary",disabled:i,onClick:()=>n(_.MOVE_UP,r),"data-testid":"LOAndAssignmentItem__moveUp"},e.createElement(ye,{fontSize:"small"})),e.createElement(J,{loading:C,actions:[_.RENAME,_.DELETE],onAction:v,recordName:E,resource:A.LOS})))))},Ut=(a,t)=>{const s=a.map(n=>x(T({},n.learning_objective),{display_order:n.display_order})),o=t.map(n=>x(T({},n.assignment),{display_order:n.display_order}));return[...s,...o].sort(ot)},zt=a=>{const t=N(),s=O(),{topicId:o}=a,{data:n=[],refetch:l,isFetching:c}=w({entity:"topicLearningObjective",action:"TOPIC_LEARNING_OBJECTIVE_GET_MANY"})({topic_id:o},{enabled:!0,onError(p){k.warn("[useGetLOAndAssignmentTable] fetchLOs",p),t(`${s("ra.message.unableToLoadData")} ${p.message}`,"error")}}),{data:i=[],refetch:r,isFetching:m}=w({action:"syllabusTopicAssignmentGetManyByTopicId",entity:"topicAssignment"})({topic_id:o},{enabled:!0,onError(p){k.warn("[useGetLOAndAssignmentTable] fetchAssignment",p),t(`${s("ra.message.unableToLoadData")} ${p.message}`,"error")}}),d=u.exports.useMemo(()=>Ut(n,i),[n,i]),E=u.exports.useCallback(()=>{l(),r()},[r,l]);return{data:d,isFetching:c||m,refetch:E}},Ht=a=>{const{topicId:t,chapterId:s,bookId:o}=a,[n,l]=u.exports.useState(!1),{data:c,refetch:i,isFetching:r}=zt({topicId:t}),m=F(A.LOS),d=`?bookId=${o}&chapterId=${s}&parentId=${t}`,{getSwap:E}=re({data:c,key:"created_at"}),{updateOrder:p,isLoading:h}=Rt(t),L=u.exports.useCallback((g,b)=>{const S=c.findIndex(C=>ue(C)===b),y=E(g,S);y&&p([y[0],y[1]],{onSuccess:()=>{i()}})},[c,E,p,i]);return e.createElement(e.Fragment,null,e.createElement(qe,{disablePadding:!0,component:"nav","data-testid":"LOAndAssignment__root",sx:g=>({width:"100%",backgroundColor:g.palette.background.paper})},c.map((g,b)=>{const S=Le(g),y=ue(g),C=nt(g);return e.createElement($t,{key:y,data:g,disabledDown:b===c.length-1||h||r,disabledUp:b===0||h||r,topicId:t,onSuccess:i,onReOrder:L,itemId:y,isLO:S,resource:C,searchUrl:`?bookId=${o}&chapterId=${s}&parentId=${t}`})}),e.createElement(_e,null,e.createElement(W,{variant:"text",size:"medium",onClick:()=>l(!0),"data-testid":"LOAndAssignment__addLOs"},m("addLO")))),e.createElement(Bt,{topicId:t,onClose:()=>l(!1),open:n,searchURL:d}))},Vt=({expanded:a,onChange:t,className:s,children:o,name:n,endNode:l,iconUrl:c})=>e.createElement(e.Fragment,null,e.createElement(Te,{className:s,expanded:a,onChange:t,TransitionProps:{mountOnEnter:!0},sx:{width:"100%",[`&.${q.root}`]:{boxShadow:"unset"},[`&.${q.expanded}`]:{minHeight:"unset"}}},e.createElement(Ae,{active:a,avatar:e.createElement(Je,{size:"medium",src:c}),summaryContent:e.createElement(se,{variant:"body2",color:"textPrimary","data-testid":"TopicAccordion__name",maxLength:80},n),endIcon:l}),o)),Kt=a=>{const{refetch:t,topic:s,chapterId:o,bookId:n,disabledDown:l,disabledUp:c,onReOrder:i,defaultExpanded:r=!1}=a,{topic_id:m,icon_url:d,name:E}=s,[p,h]=u.exports.useState(r),[L,g]=ne(!1),{deleteTopic:b,isLoading:S}=Nt({onSuccess:t}),y=u.exports.useCallback(v=>{switch(v){case _.DELETE:return b({topicIdsList:Y(s.topic_id)});case _.RENAME:return g()}},[b,s,g]),C=()=>{h(v=>!v)};return e.createElement(e.Fragment,null,e.createElement(f,{pl:4,"data-testid":"TopicItem__root","data-value":m},e.createElement(Vt,{expanded:p,name:E,iconUrl:d,onChange:C,endNode:e.createElement(f,{display:"flex",alignItems:"center",gap:1},e.createElement(B,{size:"large",sx:{width:40,height:40},color:"primary",disabled:l,"data-testid":"TopicItem__moveDown",onClick:()=>i(_.MOVE_DOWN,m)},e.createElement(Se,{fontSize:"small"})),e.createElement(B,{size:"large",sx:{width:40,height:40},color:"primary",disabled:c,"data-testid":"TopicItem__moveUp",onClick:()=>i(_.MOVE_UP,m)},e.createElement(ye,{fontSize:"small"})),e.createElement(J,{recordName:s.name,loading:S,actions:[_.RENAME,_.DELETE],onAction:y}))},e.createElement(f,{pl:8},e.createElement(Ht,{bookId:n,chapterId:o,topicId:m})))),e.createElement(kt,{topic:s,open:L,onSuccess:t,onClose:()=>g(!1)}))},Yt=({bookId:a,chapter:t,belongToFirstChapter:s})=>{const o=F(A.TOPICS),{chapter_id:n}=t,l=O(),c=N(),[i,r]=u.exports.useState(!1),{updateOrder:m,isLoading:d}=Ie(),{data:E=[],refetch:p}=w({entity:"topic",action:"syllabusTopicGetManyByChapterId"})({chapter_id:n},{enabled:Boolean(n)}),{swap:h}=re({data:E,key:"topic_id"}),L=u.exports.useCallback((g,b)=>{const S=h(g,b);!S||m([S[0],S[1]],{onSuccess:()=>{c(l("ra.message.moveSuccess")),p()},onError:y=>{k.error("[TopicList] move topic",y),c(`${l("ra.message.moveFail")}: ${l(y.message)}`,"error")}})},[c,h,l,m,p]);return e.createElement(f,{"data-testid":"TopicList__root"},E.map((g,b)=>e.createElement(u.exports.Fragment,{key:g.topic_id},e.createElement(Kt,{defaultExpanded:s&&b===0,key:g.topic_id,topic:g,bookId:a,chapterId:n,refetch:p,onReOrder:L,disabledDown:d||b===E.length-1,disabledUp:d||b===0}),e.createElement(Qe,null))),e.createElement(f,{height:52,pl:5,display:"flex",alignItems:"center"},e.createElement(W,{color:"primary",variant:"text",onClick:()=>r(!0),"data-testid":"TopicList__createTopic"},o("addTitle"))),e.createElement(It,{chapter:t,refetch:p,onClose:()=>r(!1),open:i}))},X={root:a=>{var t;return{marginBottom:"0px",border:`1px solid ${(t=a.palette.border)==null?void 0:t.main}`,[`&.${q.expanded}:last-of-type`]:{marginBottom:"0px"},[`&.${q.root}:before`]:{opacity:"1",display:"block"}}},summaryExpanded:a=>({backgroundColor:a.palette.grey[100]}),expanded:a=>({borderLeftWidth:a.spacing(.5),borderLeftColor:a.palette.info.main})},Wt=a=>{const{className:t,children:s,name:o,expanded:n,onChange:l,endNode:c}=a;return e.createElement(Te,{className:t,sx:[X.root,n?X.expanded:{}],expanded:n,onChange:l,elevation:0},e.createElement(Ae,{active:n,expandIcon:null,sx:X.summaryExpanded,summaryContent:e.createElement(se,{variant:"subtitle2",color:"textPrimary","data-testid":"ChapterAccordion__name",maxLength:50},o),endIcon:c}),s)},jt=({bookId:a,chapter:t,onSuccess:s,refetchChapter:o,onReOrder:n,disabledUp:l,disabledDown:c,defaultExpanded:i=!1})=>{const{chapter_id:r,name:m}=t,[d,E]=u.exports.useState(i),[p,h]=ne(!1),{mutate:L,isLoading:g}=Tt({onSuccess:s}),b=()=>{h(),o()},S=C=>{E(v=>!v)},y=u.exports.useCallback(C=>{switch(C){case _.DELETE:return L({chapterIdsList:[r]});case _.RENAME:return h()}},[r,L,h]);return e.createElement(Ct,{open:p,overlayContent:e.createElement(At,{bookId:a,chapter:t,onClose:h,refetch:b})},e.createElement(f,{"data-testid":"ChapterItem_root","data-value":r},e.createElement(Wt,{name:m,onChange:S,expanded:d,endNode:e.createElement(f,{display:"flex",alignItems:"center",gap:1},e.createElement(B,{size:"large",sx:{width:40,height:40},color:"primary",disabled:c,"data-testid":"ChapterItem__moveDown",onClick:()=>n(_.MOVE_DOWN,r)},e.createElement(dt,{fontSize:"small"})),e.createElement(B,{size:"large",sx:{width:40,height:40},color:"primary",disabled:l,"data-testid":"ChapterItem__moveUp",onClick:()=>n(_.MOVE_UP,r)},e.createElement(mt,{fontSize:"small"})),e.createElement(J,{loading:g,onAction:y,record:t,actions:[_.RENAME,_.DELETE],recordName:m}))},e.createElement(Yt,{belongToFirstChapter:i,bookId:a,chapter:t}))))},qt=({onSuccess:a})=>{const t=O(),s=N(),o=z(),{id:n}=fe(),[l,c]=ne(!1),{upsertChapter:i,isLoading:r}=ie({bookId:n}),{handleSubmit:m,reset:d}=o,E=async h=>{i({formData:h},{onError:L=>{k.warn("[CreateChapter]",L),s("ra.common.addedFail","error")},onSuccess:()=>{s(t("ra.common.addedSuccess",{smart_count:t("resources.chapters.chapter")},{lowercase:!0})),a(),p()}})},p=u.exports.useCallback(()=>{c(!1),d({})},[d,c]);return e.createElement(ae,{formProps:{onSubmit:m(E)},methods:o},e.createElement(Oe,{disableSubmit:r,open:l,onOpen:c,onClose:p}))},Jt=({bookId:a})=>{const t=N(),s=O(),{chapterIds:o,refetch:n}=yt(a),{updateOrder:l,isLoading:c}=ie({bookId:a}),i=o.length!==0,{data:r=[],refetch:m}=w({entity:"chapter",action:"syllabusChapterGetMany"})({chapter_ids:o},{enabled:i}),{swap:d}=re({data:r,key:"chapter_id"}),E=u.exports.useCallback((p,h)=>{const L=d(p,h);if(L){const[g,b]=L;l([g,b],{onSuccess:()=>{t(s("ra.message.moveSuccess")),m()},onError:S=>{k.warn("[ChapterList re-order failed]",S),t(`${s("ra.message.moveFail")} ${s(S.message)}: `,"error")}})}},[t,m,d,s,l]);return e.createElement(e.Fragment,null,e.createElement(f,null,i&&r.map((p,h)=>e.createElement(f,{mb:1.25,key:p.chapter_id},e.createElement(jt,{bookId:a,chapter:p,onSuccess:n,refetchChapter:m,onReOrder:E,disabledUp:c||h===0,disabledDown:c||h===(r==null?void 0:r.length)-1,defaultExpanded:h===0})))),e.createElement(qt,{onSuccess:n}))},Ea=()=>{const{id:a}=fe(),t=N(),s=O(),{isLoadingUpdate:o,onDuplicate:n,onUpdate:l}=tt(),c=ce(),{open:i,onOpen:r,onClose:m}=bt(),{data:d,isLoading:E,refetch:p}=w({action:"BOOK_GET_ONE",entity:"book"})({book_id:a},{enabled:!0,onError:g=>{k.warn("[Book details]",g),t("ra.message.unableToLoadData","error")}}),h=u.exports.useCallback(({name:g})=>{const{book_id:b,book_chapters:S,school_id:y}=d;l({bookId:b,name:g,chapterIdsList:S.map(({chapter_id:C})=>C),schoolId:y},{onSuccess:()=>{p(),m()}})},[d,m,l,p]),L=u.exports.useCallback(g=>{switch(g){case _.DUPLICATE:return n({bookId:a,bookName:d.name},{onSuccess:()=>c.push(`/${D.SYLLABUS}/${A.BOOKS}`)});case _.EDIT:return r();default:return}},[n,a,d,r,c]);return E?e.createElement(Ze,null):d?e.createElement(e.Fragment,null,e.createElement(Xe,null,e.createElement(et,{title:d.name,action:e.createElement(J,{recordName:d.name,actions:[_.EDIT,_.DUPLICATE],onAction:L,buttonStyle:"square"})}),e.createElement("div",{"data-testid":"BookShow__list__chapter"},e.createElement(Jt,{bookId:a}))),e.createElement(at,{defaultValues:{name:d.name},open:i,loading:o,title:s(`resources.${A.BOOKS}.dialog.editTitle`),onClose:m,onSave:h})):null};export{Ea as default};
