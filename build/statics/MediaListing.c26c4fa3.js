var H=Object.defineProperty;var D=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable;var T=(t,e,i)=>e in t?H(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,g=(t,e)=>{for(var i in e||(e={}))P.call(e,i)&&T(t,i,e[i]);if(D)for(var i of D(e))N.call(e,i)&&T(t,i,e[i]);return t};var _=(t,e)=>{var i={};for(var s in t)P.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(t!=null&&D)for(var s of D(t))e.indexOf(s)<0&&N.call(t,s)&&(i[s]=t[s]);return i};import{a8 as z,fH as W,eB as $,c2 as k,aS as C,cG as F,r as f,e1 as Y,u as b,R as h,fI as U,fd as V,fJ as G,fK as R,aj as J,cH as K,fL as j,cV as Q,fl as X,eo as Z,dH as ee,eC as te,eq as se,d_ as ie}from"./index.7daee9ef.js";import{u as I}from"./useMutationV2.0883e427.js";const q=z(W)(({theme:t})=>({margin:t.spacing(.5,.25),overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",maxWidth:"100%",border:"1px solid rgba(0, 0, 0, 0.23)"}));q.displayName="StyledChipFileDescription";const ne=t=>{const w=t,{file:e,index:i,updateMedia:s,overrideOnDeleteMedia:a,courseId:r,onDelete:n,lessonGroupId:o,onConvertSuccessfully:p}=w,l=_(w,["file","index","updateMedia","overrideOnDeleteMedia","courseId","onDelete","lessonGroupId","onConvertSuccessfully"]),d=e instanceof File?`${e.name}.${e.type}.${e.size}.${e.lastModified}`:e.media_id,M=$(),y=k(),{mutate:S}=I({entity:C.LESSON_GROUPS,action:F.CONVERT_MEDIA}),v=r&&a?()=>a(e,i):n?()=>n(i):void 0,u=f.exports.useRef(!1);Y(()=>{u.current=!0});const c=b(),E=L=>{r&&o&&U(L)&&c(R.addLessonConvert({courseId:r,lessonGroupId:o,materials:[{media_id:L.media_id,name:(L==null?void 0:L.name)||""}],isRetry:!0})),S({data:{mediaList:[L]}},{onError:x=>{var O;(O=window.warner)==null||O.error("Error during file conversion",x.message,x),M(y("ra.common.failedToUploadFiles",{name:x.message}),"error")},onSuccess:()=>{u.current||(r&&(s==null||s()),p==null||p())}})},m=h.createElement(q,g({onDelete:v,name:e.name||"",type:e.type||"",file:e,convertPdf:E},l));return U(e)?e.type===V.MEDIA_TYPE_VIDEO?h.createElement(G,{videoId:`${e.resource}`,key:d},m):f.exports.cloneElement(m,{href:e.resource}):m},B=i=>{var s=i,{medias:t}=s,e=_(s,["medias"]);return h.createElement(J,{m:-.5,"data-testid":"MediaListing",display:"flex",flexDirection:"row",flexWrap:"wrap"},t.map((a,r)=>{const n=a instanceof File?`${a.name}.${a.type}.${a.size}.${a.lastModified}`:a.media_id;return h.createElement(ne,g({key:n,file:a,index:r},e))}))},ae=({courseId:t,lessonGroupId:e})=>{const i=K(),s=b(),[a,r]=f.exports.useState(!1),{mutateAsync:n}=I({action:F.CONVERT_MEDIA,entity:C.LESSON_GROUPS}),{mutate:o}=I({action:F.ATTACH_MATERIAL,entity:C.LESSON_GROUPS}),p=f.exports.useCallback(({query:l,onSuccess:d,onFailure:M})=>{r(!0);const y=()=>{M&&M(),r(!1)},S=()=>{d&&d(),r(!1)};o(g({lessonGroupId:e,courseId:t},l),{onSuccess:async v=>{var m;const{mediaIds:u=[],newMediaIds:c=[]}=v||{};if(e&&s(R.deleteLessonConvert({courseId:t,lessonGroupId:e,materialIds:u})),!c.length)return S();const{data:E}=await i.getList(C.MEDIA,{filter:{media_id:c,type:V.MEDIA_TYPE_PDF,converted_images:!0},pagination:{perPage:c.length,page:1},sort:{field:"created_at",order:"ASC"}});if(e&&E.length)try{await n({data:{mediaList:E}}),s(R.addLessonConvert({courseId:t,lessonGroupId:e,materials:E}))}catch(w){return(m=window.warner)==null||m.log(w),y()}return S()},onError:y})},[t,s,e,n,o,i]);return{loading:a,convertMedia:n,onAttachMaterials:p}},re=[],oe=({mediaIds:t,isPreventingDataFetching:e})=>{const{data:i=re,isFetching:s,refetch:a}=j({action:F.MANY,entity:C.MEDIA,params:{filter:{media_id:t}}},{enabled:Q(t)&&!Boolean(e),onError:r=>{var n;(n=window.warner)==null||n.warn("ERP useMediaList",r)}});return{mediaList:i,isFetchingMediaList:s,refetchMedia:a}},de=t=>{const v=t,{mediaIds:e,courseId:i,onDeleteMediaSuccessfully:s,lessonGroupId:a}=v,r=_(v,["mediaIds","courseId","onDeleteMediaSuccessfully","lessonGroupId"]),{mediaList:n,isFetchingMediaList:o,refetchMedia:p}=oe({mediaIds:e}),l=$(),d=k(),{onAttachMaterials:M}=ae({courseId:i||"",lessonGroupId:a||""}),y=f.exports.useCallback(u=>{const c=X(u.name||"");l(d("ra.common.removeSuccess",{name:`"${c}"`,smart_count:2})),s==null||s()},[s,l,d]),S=f.exports.useCallback((u,c)=>{const E=Z(n,c),{alreadyUploadedMediaIds:m,filesNeedToBeUploaded:w}=ee(E);M({query:{mediaIds:m,files:w},onSuccess:()=>y(u),onFailure:()=>{l(d("ra.common.removeFail"),te.ERROR)}})},[n,M,y,l,d]);return o?h.createElement(se,{height:64,width:"100px"}):!n||!n.length?null:h.createElement(B,g({medias:n,updateMedia:p,overrideOnDeleteMedia:S,courseId:i,lessonGroupId:a},r))};var ce=ie;function le(t,e){return e=typeof e=="function"?e:void 0,t&&t.length?ce(t,void 0,e):[]}var ue=le;const A=t=>t.medias!==void 0,pe=t=>{const[e,i]=f.exports.useState([]);if(f.exports.useEffect(()=>{if(A(t)){const r=ue(t.medias,(n,o)=>n instanceof File&&o instanceof File&&n.name===o.name&&n.size===o.size&&n.type===o.type&&n.lastModified===o.lastModified);i(r)}},[JSON.stringify(A(t)?t.medias:e)]),A(t)){const a=t,{shouldConfirmDelete:r=!0,medias:n}=a,o=_(a,["shouldConfirmDelete","medias"]);return n.length?h.createElement(B,g({medias:e,shouldConfirmDelete:r},o)):null}else{const s=t,{shouldConfirmDelete:r=!0}=s,n=_(s,["shouldConfirmDelete"]);return h.createElement(de,g({shouldConfirmDelete:r},n))}};export{pe as M};
