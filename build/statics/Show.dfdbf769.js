var ze=Object.defineProperty,qe=Object.defineProperties;var Xe=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var he=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var Ce=(e,t,o)=>t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,k=(e,t)=>{for(var o in t||(t={}))he.call(t,o)&&Ce(e,o,t[o]);if(z)for(var o of z(t))_e.call(t,o)&&Ce(e,o,t[o]);return e},G=(e,t)=>qe(e,Xe(t));var fe=(e,t)=>{var o={};for(var n in e)he.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(e!=null&&z)for(var n of z(e))t.indexOf(n)<0&&_e.call(e,n)&&(o[n]=e[n]);return o};import{g5 as Je,h$ as Le,R as a,aJ as V,ak as Te,d7 as Fe,u as we,r as m,aS as x,fd as Ze,cH as et,cV as P,i0 as tt,a8 as Oe,ek as ee,fN as at,i1 as st,cd as Ie,ch as Me,fl as ot,eC as Se,dH as nt,i2 as rt,i3 as lt,eq as it,hf as ct,aH as te,eX as M,eS as ge,aj as f,aK as H,d5 as ae,aI as se,cm as dt,i4 as ut,d0 as Ee,c$ as de,dc as mt,cx as ce,eQ as De,bj as be,b8 as ye,b9 as J,aG as pt,eG as St,dQ as gt,ci as F,hL as Ue,i5 as Et,d2 as Be,d3 as bt,cR as Re,cX as j,e3 as yt,gA as Ct,et as ht,hN as _t,g0 as ft,i6 as Lt,i7 as Ae,fW as Ge,h_ as Tt,eb as Dt,g2 as At,i8 as Ve,d6 as Nt,hG as Pt,hu as kt,eZ as q,d9 as xt,eV as vt,eY as Ft,i9 as wt}from"./index.7daee9ef.js";import{i as Y,a as oe}from"./infer-query.264ca744.js";import{M as Ot}from"./MediaListing.c26c4fa3.js";import{r as I,w as Q,x as U,u as w,v as B,y as ue}from"./useShowSnackbar.da46e481.js";import{F as It}from"./FormUploadMaterials.c32fc30a.js";import{u as Mt}from"./useHookFormField.c60f8756.js";import{u as Ut}from"./useNavigation.f38e637f.js";import{a as Bt}from"./AvatarInputHF.36ed1c41.js";import{u as Rt}from"./useStandaloneQuery.29e2103e.js";import{u as Gt,D as Vt}from"./useUpsertCourse.67c4bc5f.js";import{T as Yt}from"./ToggleButtonGroupBase.1fda97a3.js";import{S as me,u as Ye,s as W,B as $t,g as Kt,D as Ht}from"./utils.c80bdd07.js";import{T as Z}from"./TypographyMaxLines.88e560ab.js";import{u as Qt}from"./useDialog.8ab3e0e0.js";import"./useMutationV2.0883e427.js";import"./BrightcoveLogoIcon.9d2bdc09.js";import"./UploadInput.4c4e4115.js";import"./IconButtonBase.a835a6a3.js";import"./useSafeState.fc2ddfd3.js";import"./useBasicContent.160dc809.js";import"./useNotifyForm.ee77e08e.js";import"./display-order.ffc5e670.js";const pe={addLessonConvert(e){return{type:"ADD_LESSON_CONVERT",payload:e}},deleteLessonConvert(e){return{type:"DELETE_LESSON_CONVERT",payload:e}},updateLessonConvertStatus(e){return{type:"UPDATE_LESSON_CONVERT_STATUS",payload:e}},clearLessonConvert(e){return{type:"CLEAR_LESSON_CONVERT",payload:e}}},Wt=({lessonConvert:e})=>e,jt=e=>e===Le.CONVERSION_TASK_STATUS_WAITING||e===Le.CONVERSION_TASK_STATUS_CONVERTING,zt=e=>{let t=!1;const o=e.length;for(let n=0;n<o;n++){const r=e[n];if(jt(r.status)){t=!0;break}}return t};Je(Wt,e=>{const t=[];return Object.keys(e).forEach(o=>{e[o].forEach((r,s)=>{zt(r)&&t.push({courseId:o,lessonGroupId:s,material:r})})}),t});const $e=e=>{const t=I(),{onCancel:o,onOK:n,className:r,loading:s,okText:i=t("ra.action.save"),cancelText:c=t("ra.action.cancel"),disabled:d}=e;return a.createElement(V,{container:!0,className:r,justifyContent:"flex-end"},a.createElement(V,{item:!0},a.createElement(Te,{"data-testid":"BaseDialogAction__cancel",onClick:o,sx:l=>({"&:first-of-type":{marginRight:l.spacing(2)}}),size:"large","aria-label":c,disabled:s},c),a.createElement(Te,{"data-testid":"BaseDialogAction__ok",onClick:n,disabled:d,size:"large",color:"primary",variant:"contained","aria-label":i,startIcon:a.createElement(Fe,{loading:s,size:16})},i)))};$e.defaultProps={disabledOK:!1,loading:!1};const qt=({courseId:e,lessonGroupId:t})=>{const o=et(),n=we(),[r,s]=m.exports.useState(!1),{mutateAsync:i}=Q({entity:"lessonGroups",action:"lessonGroupsConvertMedia"})(),{mutate:c}=Q({entity:"lessonGroupsYasuo",action:"lessonGroupAttachMaterialsToCourse"})(),d=m.exports.useCallback(({query:l,onSuccess:p,onFailure:y})=>{s(!0);const g=()=>{y&&y(),s(!1)},C=()=>{p&&p(),s(!1)};c(k({lessonGroupId:t,courseId:e},l),{onSuccess:async b=>{const{mediaIds:E=[],newMediaIds:u=[]}=b.data||{};if(t&&n(pe.deleteLessonConvert({courseId:e,lessonGroupId:t,materialIds:E})),!u.length)return C();const{data:S}=await o.getList(x.MEDIA,{filter:{media_id:u,type:Ze.MEDIA_TYPE_PDF,converted_images:!0},pagination:{perPage:u.length,page:1},sort:{field:"created_at",order:"ASC"}});if(t&&S.length)try{await i({mediaList:S}),n(pe.addLessonConvert({courseId:e,lessonGroupId:t,materials:S}))}catch(h){return U.info("[useAttachMaterials]",h),g()}return C()},onError:g})},[e,n,t,i,c,o]);return{loading:r,convertMedia:i,onAttachMaterials:d}},Xt=[],Jt=({mediaIds:e,isPreventingDataFetching:t})=>{const{data:o=Xt,isFetching:n,refetch:r}=Y({entity:"media",action:"MEDIA_GET_MANY"})({media_id:e},{enabled:P(e)&&!Boolean(t),onError:s=>{U.error("ERP useMediaList",s)}});return{mediaList:o,isFetchingMediaList:n,refetchMedia:r}},Zt={dialog:{[`& .${tt.paper}`]:{maxWidth:"770px"},margin:0},fileList:e=>({marginBottom:e.spacing(2),"& > div":{margin:e.spacing(0,1,1,0)}})},ea=Oe($e)(({theme:e})=>({paddingTop:e.spacing(2)})),ta=[{accept:ee.VIDEO,maxSize:at},{accept:ee.PDF,maxSize:st}],aa=({open:e,lessonGroupId:t,courseId:o,mediaIds:n,onClose:r,refetchLessonGroup:s})=>{const i=w(Ie.LESSON_SYLLABUS),c=I(),d=we(),l=B(),{reset:p}=Me(),[y,g]=Mt("files",[]),{onAttachMaterials:C,loading:b}=qt({courseId:o,lessonGroupId:t}),{mediaList:E,isFetchingMediaList:u}=Jt({mediaIds:n});m.exports.useEffect(()=>{g(E)},[E,g]);const S=m.exports.useCallback(()=>{p({files:[]}),r()},[r,p]),h=m.exports.useCallback(L=>{l(c(L,{smart_count:1})),s(),S()},[l,c,S,s]),_=m.exports.useCallback(L=>{const A=ot(t);l({key:"ra.common.failedToUploadFiles",options:{name:A}},Se.ERROR),d(pe.deleteLessonConvert({courseId:o,lessonGroupId:t,materialIds:L}))},[t,l,d,o]),T=m.exports.useCallback(()=>{const{alreadyUploadedMediaIds:L,filesNeedToBeUploaded:A}=nt(y);C({query:{mediaIds:L,files:A},onSuccess:()=>h("ra.common.updatedSuccess"),onFailure:()=>_(L)})},[y,C,_,h]),D=m.exports.useCallback(L=>rt(L,ta),[]);return a.createElement(lt,{sx:Zt.dialog,open:e,maxWidth:!1,minWidth:"770px",disableEscapeKeyDown:!0,title:i("uploadMaterials"),disabled:b,onClose:S},u?a.createElement(it,{"data-testid":"LessonUploadDialog__loading",height:210}):a.createElement(It,{files:y,onChange:g,variant:"outlined",isBrightCoveOptional:!0,formUploadFileProps:{multiple:!0,customFilterFn:D,accept:[ee.PDF,ee.VIDEO]}}),a.createElement(ea,{disabled:b||!n.length&&!y.length,loading:b,onCancel:S,onOK:T}))},sa=e=>{const{data:t=[]}=Y({entity:"lessonsSyllabus",action:"lessonSyllabusGetMany"})({course_id:e},{enabled:!0,selector(i){return i?i.map(c=>c.lesson_group_id||""):[]}}),{result:{data:o=[],isLoading:n,refetch:r},pagination:s}=oe({entity:"lessonGroups",action:"lessonGroupGetListWithFilter"})({lesson_group_ids:t,course_id:e},{enabled:!0,defaultLimit:50});return{lessonGroupListQuery:o,loading:n,pagination:s,updateLessonGroups:r}},oa=({courseId:e})=>{const t=ct[x.BOOKS],o=w(Ie.LESSON_SYLLABUS),[n,r]=m.exports.useState(!1),[s,i]=m.exports.useState(""),[c,d]=m.exports.useState([]),l=te({defaultValues:{files:[]}}),{lessonGroupListQuery:p,loading:y,pagination:g,updateLessonGroups:C}=sa(e),b=m.exports.useCallback((u,S)=>{switch(i(S.lesson_group_id),d(S.media_ids||[]),u){case M.UPLOAD_FILE:return r(!0)}},[]),E=[{key:t,title:o("week"),render:u=>a.createElement("span",null,u.lesson_group_id)},{key:"name",title:o("materialsList"),render:u=>a.createElement(Ot,{mediaIds:u.media_ids,shouldConfirmDelete:!0,requirePdfConversion:!0,lessonGroupId:u.lesson_group_id,courseId:e,onDeleteMediaSuccessfully:C})},{key:"action",title:"Action",render:u=>a.createElement(ge,{record:u,recordName:u.lesson_group_id,onAction:b,actions:[M.UPLOAD_FILE]})}];return a.createElement(f,{"data-testid":"LessonTab"},a.createElement(f,{padding:3},a.createElement(H,{"data-testid":"LessonTab__title",variant:"h6"},o("uploadMaterials"))),a.createElement(ae,{columns:E,data:p,tableProps:{"data-testid":"LessonTab__table"},body:{rowKey:t,loading:y,pagination:g}}),n?a.createElement(se,{methods:l},a.createElement(aa,{open:n,courseId:e,lessonGroupId:s,mediaIds:c,onClose:()=>r(!1),refetchLessonGroup:C})):null)},na=({entity:e,customActions:t={},mapActions:o})=>{const{permission:n}=dt();return{actions:m.exports.useMemo(()=>Object.entries(o).filter(([,{action:i}])=>n.can(e,i)).map(([i])=>t[i]||i),[n,e,t,o])}},Ne={[M.EDIT]:{action:ut.EDIT},[M.DELETE]:{action:"delete.course_delete"}},ra=()=>{const{actions:e}=na({entity:x.COURSES,mapActions:Ne});return{mapActions:Ne,actions:e}},la=r=>{var s=r,{recordId:e,recordName:t,onEdit:o}=s,n=fe(s,["recordId","recordName","onEdit"]);const i=I(),c=Ut(),d=B(),{actions:l}=ra(),{mutate:p,isLoading:y}=Q({action:"courseDelete",entity:"coursesYasuo"})({onSuccess:()=>{d(i("ra.common.deleteSuccess",{smart_count:i(`resources.${x.COURSES}.name`)},{lowercase:!0})),c.push(`/${Ee.SYLLABUS}/${x.COURSES}`)},onError:()=>{d(i("ra.common.deleteFail"),Se.ERROR)}}),g=m.exports.useCallback(C=>{switch(C){case M.DELETE:return p({courseIdsList:[e]});case M.EDIT:return o();default:return}},[p,o,e]);return!l||!l.length?null:a.createElement(ge,k({resource:x.COURSES,loading:y,recordName:t,actions:l,onAction:g,buttonStyle:"square"},n))},ia=e=>P(e)?e.map(t=>t.name).join(", "):"",ca=e=>{const{course:t,locations:o,isLoadingLocation:n,refetch:r}=e,s=B(),i=I(),c=w(x.COURSES),{mutate:d,isLoading:l}=Q({entity:"coursesYasuo",action:"courseCreate"})({onSuccess:()=>{s(c("updateCourseIconSuccess")),r()},onError:()=>{s(i("ra.common.updatedFail"),Se.ERROR)}}),{isEnabled:p}=ue(de.LESSON_COURSE_BACK_OFFICE_TEACHING_METHOD),y=m.exports.useCallback(b=>{var E;if(Boolean((E=b.target.files)==null?void 0:E.length)){const u=Array.from(b.target.files||[]);return d({name:t.name,course_id:t.course_id,school_id:t.school_id,display_order:t.display_order,icon:t.icon,chapter_ids:[],files:u})}},[d,t]),g=m.exports.useCallback(()=>d({name:t.name,course_id:t.course_id,school_id:t.school_id,display_order:t.display_order,chapter_ids:[],icon:void 0}),[d,t]),C=ia(o);return a.createElement(f,null,a.createElement(f,{display:"flex",justifyContent:"center",pb:3},a.createElement(Bt,{name:"icon",shouldDelete:!0,src:t.icon||void 0,readOnly:l,onChange:y,onRemove:g})),a.createElement(mt,null),a.createElement(f,{pt:3},a.createElement(ce,{label:c("courseName"),value:t.name,variant:"horizontal",xsLabel:2,xsValue:10,dataTestidValue:"SettingsTabForm__courseName"}),a.createElement(f,{pt:1.5},a.createElement(ce,{label:c("location"),value:C,variant:"horizontal",xsLabel:2,xsValue:10,dataTestidValue:"SettingsTabForm__locationsName",isLoading:n})),p&&a.createElement(f,{pt:1.5},a.createElement(ce,{label:c("teachingMethod"),value:t.teaching_method?c(t.teaching_method):"",variant:"horizontal",xsLabel:2,xsValue:10,dataTestidValue:"SettingsTabForm__teachingMethod"}))))},da=e=>{const{course:t}=e,o=te({defaultValues:t});return a.createElement(f,{sx:n=>({padding:n.spacing(3,4)})},a.createElement(se,{methods:o},a.createElement(ca,k({},e))))},Ke=Oe(ge)(()=>({justifyContent:"center"}));Ke.displayName="StyledActionPanel";const ua=e=>{const{data:t,isLoading:o,pagination:n,onMutationClass:r}=e,s=w(x.CLASS),i=m.exports.useMemo(()=>[{key:"colClassName",title:s("columns.className"),render:d=>a.createElement(De,{variant:"body2","data-testid":"ClassTable__typographyClassName"},d.name)},{key:"colLocation",title:s("columns.location"),cellProps:{width:"20%"},render:d=>a.createElement(De,{variant:"body2","data-testid":"ClassTable__typographyLocation"},d.location.name)},{key:"colAction",title:s("columns.action"),cellProps:{align:"center",width:"20%",padding:"none"},render:d=>a.createElement(Ke,{recordName:"",actions:[{action:M.EDIT},{action:M.DELETE,withConfirm:!1}],onAction:l=>r(l,d)})}],[r,s]),c="class_id";return a.createElement(ae,{body:{loading:o,rowKey:c,pagination:n,skeCount:3},withIndex:!0,data:t,columns:i,footer:P(t)?{pagination:n}:void 0,tableProps:{"data-testid":"ClassTable__table"}})},ma=e=>{const{open:t,onClose:o,classData:n,onDeleteClass:r,isDeleting:s}=e,i=be(),c=I(),d=w(x.CLASS),l=d("areYouSureToDelete",{className:`<span style="color: ${i.palette.text.primary}">${n.name}</span>`});return a.createElement(ye,{open:t,onClose:o,onSave:()=>r(n),textSave:c("ra.action.confirm"),footerConfirmButtonProps:{color:"error",disabled:s},title:d("titles.deleteAClass"),"data-testid":"DialogDeleteClass__dialog"},a.createElement(J,{variant:"body1"},a.createElement("span",{dangerouslySetInnerHTML:{__html:l}})))},pa=e=>{const{defaultValues:t,render:o}=e,n=te({defaultValues:t}),r=m.exports.useMemo(()=>o({handleSubmit:n.handleSubmit}),[n.handleSubmit,o]);return a.createElement(se,{methods:n},r)},Sa=e=>{const{open:t,onClose:o,classData:n,onEditClass:r,isEditing:s}=e,i=I(),c=w(x.CLASS),d=l=>{if(St(l.name,n.name)){o();return}r(k(k({},n),l))};return a.createElement(pa,{defaultValues:{name:n.name},render:({handleSubmit:l})=>a.createElement(ye,{open:t,onClose:o,title:c("titles.edit"),onSave:l(d),"data-testid":"DialogEditClass__dialog",footerConfirmButtonProps:{disabled:s}},a.createElement(pt,{required:!0,name:"name",label:c("columns.className"),rules:{required:i("resources.input.error.required")},inputProps:{"data-testid":"DialogEditClass__textFieldClassName"}}))})},ga=e=>{const{open:t,onClose:o,classAssociation:n}=e,r=I(),s=w(x.CLASS);return a.createElement(ye,{open:t,onSave:o,onClose:o,textSave:r("ra.action.close"),shouldShowCancelButton:!1,title:s("titles.deleteAClass"),"data-testid":"DialogNotAllowDeleteClass__dialog"},a.createElement(f,{pb:2},a.createElement(J,{variant:"body1"},s("youCanNotDeleteThisClass"))),n.student&&a.createElement(J,{variant:"body1","data-testid":"DialogNotAllowDeleteClass__studentAssociate"},`\u2022 ${s("thereAreStudentInTheClass")}`),n.lesson&&a.createElement(J,{variant:"body1","data-testid":"DialogNotAllowDeleteClass__lessonAssociate"},`\u2022 ${s("thereAreLessonInTheClass")}`))},Pe={lesson:!1,student:!1},Ea=()=>{const[e,t]=m.exports.useState(!1),o=I(),n=B(),{classService:r}=Rt();return{getClassAssociation:m.exports.useCallback(async i=>{var c,d;try{t(!0);const l=await r.classGetClassAssociationByCourseId({class_id:i});return l?{lesson:Boolean((c=l==null?void 0:l.lessons_aggregate.aggregate)==null?void 0:c.count),student:Boolean((d=l==null?void 0:l.class_member_aggregate.aggregate)==null?void 0:d.count),isQuerySucceed:!0}:Pe}catch(l){const p=gt(l);U.error("[useClassAssociation]",p),n(o("ra.manabie-error.unknown"),"error")}finally{t(!1)}return Pe},[r,n,o]),isLoading:e}},ba={data:[],total:0},ya=({courseId:e})=>{const t=I(),o=w(x.CLASS),n=B(),{result:{isLoading:r,refetch:s,isFetching:i},data:c=ba,pagination:d,resetPaginationOffset:l}=oe({entity:"class",action:"classGetListByCourseId"})({course_id:e},{enabled:Boolean(e),defaultLimit:5,defaultOffset:0,selector:({data:u,total:S})=>({data:u||[],total:S}),onSuccess:({data:u,total:S})=>{!P(u)&&S>0&&l()}}),{mutate:p,isLoading:y}=Q({entity:"classMaster",action:"classUpdate"})({onSuccess:async()=>{n(o("messages.editSuccessfully")),await s()},onError:u=>{U.error("[useClassManagement] classUpdate:",u),n(t("ra.manabie-error.unknown"),"error")}}),g=m.exports.useCallback(u=>{const{classData:S,onError:h,onSuccess:_}=u;p({classId:S.class_id,name:S.name},{onSuccess:_,onError:h})},[p]),{mutate:C,isLoading:b}=Q({entity:"classMaster",action:"classDelete"})({onSuccess:async()=>{n(o("messages.deleteSuccessfully")),await s()},onError:u=>{U.error("[useClassManagement] classDelete:",u),n(t("ra.manabie-error.unknown"),"error")}}),E=m.exports.useCallback(u=>{const{classData:S,onSuccess:h,onError:_}=u;C({classId:S.class_id},{onSuccess:h,onError:_})},[C]);return{classesList:c.data,isLoading:r||i,pagination:d,handleEditClass:g,isEditing:y,handleDeleteClass:E,isDeleting:b}},Ca=()=>{const[e,t]=m.exports.useState(!1),[o,n]=m.exports.useState(!1),[r,s]=m.exports.useState(!1),[i,c]=m.exports.useState(null),[d,l]=m.exports.useState(null);return{classData:i,classAssociation:d,editActions:{openEditDialog:e,showEditClassDialog:u=>{c(u),t(!0)},hideEditClassDialog:()=>{c(null),t(!1)}},deleteActions:{openDeleteDialog:o,showDeleteClassDialog:u=>{c(u),n(!0)},hideDeleteClassDialog:()=>{c(null),n(!1)}},canNotDeleteActions:{openCanNotDeleteDialog:r,showCanNotDeleteClassDialog:u=>{l(u),s(!0)},hideCanNotDeleteClassDialog:()=>{l(null),s(!1)}}}},ha=({courseId:e})=>{const{classData:t,classAssociation:o,editActions:{openEditDialog:n,showEditClassDialog:r,hideEditClassDialog:s},deleteActions:{openDeleteDialog:i,showDeleteClassDialog:c,hideDeleteClassDialog:d},canNotDeleteActions:{openCanNotDeleteDialog:l,showCanNotDeleteClassDialog:p,hideCanNotDeleteClassDialog:y}}=Ca(),{classesList:g,pagination:C,isLoading:b,handleEditClass:E,isEditing:u,handleDeleteClass:S,isDeleting:h}=ya({courseId:e}),{getClassAssociation:_,isLoading:T}=Ea(),D=m.exports.useCallback(async N=>{const{lesson:v,student:$,isQuerySucceed:K}=await _(N.class_id),R=v||$;R&&!T&&p({lesson:v,student:$}),!R&&!T&&K&&c(N)},[_,T,p,c]),L=m.exports.useCallback(async(N,v)=>{switch(N){case M.EDIT:{r(v);break}case M.DELETE:await D(v);break}},[r,D]),A=N=>{E({classData:N,onSuccess:s})},O=N=>{S({classData:N,onSuccess:d})};return a.createElement(a.Fragment,null,a.createElement(f,{p:3},a.createElement(ua,{data:g,isLoading:b,pagination:C,onMutationClass:L})),n&&t&&a.createElement(Sa,{open:n,classData:t,onEditClass:A,isEditing:u,onClose:s}),i&&t&&a.createElement(ma,{open:i,classData:t,onDeleteClass:O,isDeleting:h,onClose:d}),l&&o&&a.createElement(ga,{open:l,onClose:y,classAssociation:o}))},He=(e,t=!0)=>{const o=[];return(P(e)?e:[]).forEach(r=>{r.book_id&&o.push(r.book_id)}),t?[...new Set(o)]:o},_a=e=>{const{filter:t,courseId:o,searchText:n}=e,r=B(),{result:{isLoading:s,isFetching:i},data:c={data:[],total:0},pagination:d,resetPaginationOffset:l}=oe({entity:"courseStudyPlan",action:"COURSE_STUDY_PLAN_GET_LIST_FILTER"})({courseId:o,search:n,status:[me.STUDY_PLAN_STATUS_ACTIVE].concat(t.archived?me.STUDY_PLAN_STATUS_ARCHIVED:[]),bookIds:t.bookIds,grades:t.grades},{enabled:Boolean(o),onError:b=>{U.warn("[useGetCourseStudyPlan]",b),r("ra.message.unableToLoadData","error")}}),p=He((c.data||[]).map(b=>b.study_plan)),{data:y={},isFetching:g}=Y({entity:"book",action:"BOOK_GET_MANY"})({book_id:p},{enabled:P(p),selector:b=>b.reduce((E,u)=>(E[u.book_id]=u.name,E),{})});return{data:m.exports.useMemo(()=>(c.data||[]).map(b=>{const{study_plan:E}=b,{name:u,grades:S,study_plan_id:h,status:_}=E,T={grades:S,name:u,studyplanId:h,status:_},D=E.book_id;return D&&y[D]?G(k({},T),{bookName:y[D]}):T}),[y,c]),isLoading:s,isFetching:i,isFetchingBook:g,pagination:d,resetPaginationOffset:l}},ke={colName:{width:"40%"},colBook:{width:"40%"}},fa=e=>{const{courseId:t,filter:o,keyword:n}=e,r=w(F.STUDY_PLANS),{convertGradeToString:s}=Ye(),i=be(),c=`?${Ue.COURSE_ID}=${t}`,{isLoading:d,isFetching:l,data:p,pagination:y,resetPaginationOffset:g}=_a({courseId:t,filter:o,searchText:n}),C=m.exports.useMemo(()=>p.map(E=>Et(E,E.status!==me.STUDY_PLAN_STATUS_ACTIVE?{backgroundColor:i.palette.grey[100],position:"unset"}:{})),[p,i.palette.grey]),b=[{key:"colName",title:r("studyPlanName"),cellProps:{sx:ke.colName},render:({studyplanId:E,name:u})=>a.createElement(Be,{to:`/${Ee.SYLLABUS}/${F.STUDY_PLANS}/${E}/show${c}`},a.createElement(bt,{maxLength:60,variant:"body2"},Re(u)))},{key:"colBook",title:r("bookAssociation"),cellProps:{sx:ke.colBook},dataIndex:"bookName",render:({bookName:E})=>a.createElement(H,{variant:"body2","data-testid":"CourseStudyPlanTable__bookCol"},E||a.createElement(j,null))},{key:"colGrade",title:r("grade"),render:({grades:E})=>a.createElement(H,{variant:"body2","data-testid":"CourseStudyPlanTable__gradeCol"},P(E)?s(E):a.createElement(j,null))}];return m.exports.useEffect(()=>{g()},[n,JSON.stringify(o)]),a.createElement(ae,{data:C,columns:b,body:{loading:d||l,rowKey:"studyplanId"},footer:{pagination:y},tableProps:{"data-testid":"CourseStudyPlanTable"}})};var La=m.exports.memo(fa);const Ta=e=>{const{isNoData:t,defaultValue:o,filterFieldObjects:n,onApplySubmit:r,reset:s,watch:i,getValues:c,defaultFilterAppliedObjects:d=[],onSetFilterAppliedObjects:l}=e,p=I(),y=B(),[g,C]=m.exports.useState(d),b=i(),E=m.exports.useCallback(()=>{C([]),l&&l([]),s(o),r(o)},[o,r,l,s]),u=m.exports.useCallback(()=>s(b),[b,s]),S=m.exports.useCallback(T=>{const D=Object.keys(n),L=c();return D.map(O=>{const N=L[O],v=Array.isArray(N)?P(N):!!N;if(!T){const $=g.some(K=>K.name===O&&K.isApplied);return G(k({},n[O]),{isApplied:v&&$})}return G(k({},n[O]),{isApplied:v})}).filter(O=>O.isApplied)},[g,n,c]),h=m.exports.useCallback(T=>{const D=n[T].defaultValue,L=G(k({},b),{[T]:D});s(L);const A=S(!1);C(A),l&&(l==null||l(A)),r(L)},[n,S,b,r,l,s]),_=m.exports.useCallback(T=>{if(t){g.some(A=>A.isApplied)&&E(),y(p("ra.message.invalidSearchQueryReturningAllItems"),"info");return}const D=S(!0);C(D),l&&(l==null||l(D)),r(T)},[g,S,E,t,r,l,y,p]);return{filterApplied:g,onReset:E,onApply:_,onDelete:h,onClosePopover:u}},Da=e=>({grades:{name:"grades",inputLabel:e("grade"),isApplied:!1,defaultValue:W.grades},books:{name:"books",inputLabel:e("bookAssociationName"),isApplied:!1,defaultValue:W.books},archived:{name:"archived",inputLabel:e("showArchivedStudyPlan"),isApplied:!1,defaultValue:W.archived}}),Aa=e=>{const{resource:t,onEnterSearchBar:o,onApplySubmit:n}=e,r=w(F.STUDY_PLANS),s=Me(),{archived:i,books:c,grades:d}=yt({control:s.control}),l=!i&&!P(c)&&!P(d),p=Da(r),{filterApplied:y,onDelete:g,onApply:C,onReset:b,onClosePopover:E}=Ta(k({defaultValue:W,isNoData:l,filterFieldObjects:p,onApplySubmit:n},s));return m.exports.useEffect(()=>{b()},[t,b]),a.createElement(Ct,{isDisableReset:l,filterNameApplied:y,onEnterSearchBar:o,onDelete:g,onReset:b,onApply:s.handleSubmit(C),onClosePopover:E},a.createElement(f,{width:512},a.createElement(f,{mb:1},a.createElement(H,{variant:"subtitle2"},r("name"))),a.createElement(V,{container:!0,spacing:2},a.createElement(V,{container:!0,item:!0,spacing:2},a.createElement(V,{item:!0,xs:6},a.createElement(ht,{name:p.grades.name,label:p.grades.inputLabel,multiple:!0,filterSelectedOptions:!0,disableCloseOnSelect:!0,getOptionSelectedField:"id"})),a.createElement(V,{item:!0,xs:!0},a.createElement($t,{name:p.books.name,label:p.books.inputLabel,filterSelectedOptions:!0,disableCloseOnSelect:!0,limitChipText:"Ellipsis",getOptionSelectedField:"book_id"}))),t===F.COURSE_STUDY_PLANS&&a.createElement(V,{container:!0,item:!0,spacing:2},a.createElement(V,{item:!0,xs:12},a.createElement(_t,{name:p.archived.name,label:p.archived.inputLabel}))))))},Na=({courseId:e,filter:t,keyword:o})=>{const n=B(),{resetPaginationOffset:r,pagination:s,data:i={data:[],total:0},result:{isLoading:c}}=oe({entity:"courseStudent",action:"COURSE_STUDENT_GET_LIST_BY_FILTER"})({courseId:e,search:o,bookIds:t.bookIds,grades:t.grades},{enabled:Boolean(e),selector:({data:S,total:h})=>({data:S==null?void 0:S.map(_=>_.student_id),total:h}),onError:S=>{U.warn("useStudentStudyPlansQuery",S),n("ra.message.unableToLoadData","error")}}),{data:d=[],isLoading:l}=Y({entity:"student",action:"STUDENT_GET_MANY"})({user_ids:i.data},{enabled:P(i.data),selector:S=>[...S||[]].sort((h,_)=>(i.data||[]).indexOf(h.user_id)-(i.data||[]).indexOf(_.user_id))}),{data:p=[],isFetching:y}=Y({entity:"studentStudyPlan",action:"STUDENT_STUDY_PLAN_GET_MANY_BY_FILTER"})({courseId:e,search:o,bookIds:t.bookIds,grades:t.grades,studentIds:i.data||[]},{enabled:P(i.data)}),g=He(p),{data:C={},isFetching:b}=Y({entity:"book",action:"BOOK_GET_MANY"})({book_id:g},{enabled:P(g),selector:S=>S.reduce((h,_)=>(h[_.book_id]=_.name,h),{})}),E=m.exports.useCallback((S,h)=>S.map(_=>{const{name:T,grades:D=[],study_plan_id:L,book_id:A,created_at:O,student_study_plans:N}=_,{student_id:v}=N[0],$={grades:D,name:T,studyplanId:L,bookId:A,created_at:O,studentId:v};return A&&h[A]?G(k({},$),{bookName:h[A]}):$}),[]);return{studyPlanListByStudent:P(i.data)?Kt({studentList:d,studyPlanList:E(p,C)}):[],isFetchingBook:b,isLoading:c||l||y,pagination:s,resetPaginationOffset:r}},X={colStudentName:{width:"26.5%"},colStudyPlanName:{width:"26.5%"},colBookName:{width:"26.5%"},colGrade:{width:"20.5%"}},Pa=e=>{const t=w(x.COURSES),o=`?${Ue.COURSE_ID}=${e}`,{convertGradeToString:n}=Ye();return{columns:[{key:"colStudentName",title:t("studyPlan.studentName"),cellProps:{sx:X.colStudentName,"data-testid":"StudentStudyPlanTableColumns__studentName"}},{key:"colStudyPlanName",title:t("studyPlan.studyPlanName"),cellProps:{sx:X.colStudyPlanName,"data-testid":"StudentStudyPlanTableColumns__studyPlanName"},render:({studyplanId:s,name:i})=>a.createElement(Be,{to:`/${Ee.SYLLABUS}/${F.STUDY_PLANS}/${s}/show${o}`,"data-testid":"StudentStudyPlanTableBodyColumns__studyPlanName"},a.createElement(Z,{maxLines:1,variant:"body2"},Re(i)))},{key:"colBookName",title:t("studyPlan.bookAssociation"),cellProps:{sx:X.colBookName,"data-testid":"StudentStudyPlanTableColumns__bookAssociation"},render:({bookName:s})=>a.createElement(f,{"data-testid":"StudentStudyPlanTableBodyColumns__bookName"},s?a.createElement(Z,{maxLines:1,variant:"body2"},s):a.createElement(j,null))},{key:"colGrade",title:t("grade"),cellProps:{sx:X.colGrade,"data-testid":"StudentStudyPlanTableColumns__grade"},render:({grades:s})=>a.createElement(f,{"data-testid":"StudentStudyPlanTableBodyColumns__grades"},P(s)?a.createElement(Z,{maxLines:1,variant:"body2"},n(s)):a.createElement(j,null))}]}},xe=({studyPlan:e,columns:t,border:o,dataIndex:n})=>t.map((r,s)=>{var i;return a.createElement(Ge,G(k({key:r.key},r.cellProps),{border:o,maxColumnIndex:t.length-1,columnIndex:s}),e?(i=r.render)==null?void 0:i.call(r,e,n):a.createElement(j,null))}),ka=e=>{const{columns:t,data:o,rowKey:n}=e,r=be(),s={columns:t,rowKey:n,border:ft(r,Lt.all)};return a.createElement(a.Fragment,null,o.map(({studentId:i,studentName:c,studyPlanList:d})=>a.createElement(m.exports.Fragment,{key:i},a.createElement(Ae,G(k({},s),{dataIndex:0,record:d[0],render:l=>a.createElement(a.Fragment,null,a.createElement(Ge,k({border:s.border,rowSpan:d.length||1,style:{verticalAlign:"top"}},l[0].cellProps),a.createElement(f,{"data-testid":"StudentStudyPlanTableBody__studentName"},a.createElement(Z,{maxLines:1,variant:"body2"},c))),xe({studyPlan:d[0],border:s.border,columns:l.slice(1),dataIndex:0}))})),d.slice(1).map((l,p)=>a.createElement(Ae,G(k({},s),{key:l.studyplanId,dataIndex:p,record:l,render:y=>xe({studyPlan:l,border:s.border,columns:y.slice(1),dataIndex:p})}))))))},xa=({courseId:e,keyword:t,filter:o})=>{const n=Tt(F.COURSE_STUDENTS),{studyPlanListByStudent:r,isLoading:s,pagination:i,resetPaginationOffset:c}=Na({courseId:e,keyword:t,filter:o}),{columns:d}=Pa(e);return m.exports.useEffect(()=>{c()},[t,JSON.stringify(o)]),a.createElement(ae,{data:r,columns:d,body:{loading:s,rowKey:n,customBody:a.createElement(ka,{columns:d,data:r,rowKey:n})},footer:{pagination:i},tableProps:{"data-testid":"StudentStudyPlanTable"}})},va=e=>{const{courseId:t}=e,[o,n]=m.exports.useState(!1),r=I(),[s,i]=m.exports.useState(F.COURSE_STUDY_PLANS),c=te({defaultValues:W}),[d,l]=m.exports.useState(""),[p,y]=m.exports.useState({archived:!1,bookIds:[],grades:[]}),g=m.exports.useMemo(()=>[{value:F.COURSE_STUDY_PLANS,children:a.createElement(H,{variant:"button"},r(`resources.${F.STUDY_PLANS}.master`))},{value:F.STUDENT_STUDY_PLANS,children:a.createElement(H,{variant:"button"},r(`resources.${F.STUDY_PLANS}.individual`))}],[r]),C=m.exports.useCallback((E,u)=>u&&i(u),[]),b=m.exports.useCallback(({archived:E,books:u,grades:S})=>{y({archived:E,bookIds:u.map(({book_id:h})=>h),grades:S.map(({id:h})=>h)})},[]);return a.createElement(a.Fragment,null,a.createElement(f,{p:3},a.createElement(Dt,null,a.createElement(f,{p:3},a.createElement(f,null,a.createElement(Yt,{exclusive:!0,value:s,onChange:C,options:g})),a.createElement(f,{mt:2,display:"flex",justifyContent:"space-between",alignItems:"start"},a.createElement(se,{methods:c},a.createElement(Aa,{resource:s,onApplySubmit:b,onEnterSearchBar:l})),s===F.COURSE_STUDY_PLANS&&a.createElement(At,{variant:"outlined",onClick:()=>n(!0),"data-testid":"StudyPlanTab__addStudyPlan"},r("ra.common.action.add"))),a.createElement(f,{mt:2},s===F.COURSE_STUDY_PLANS&&a.createElement(La,{courseId:t,filter:p,keyword:d}),s===F.STUDENT_STUDY_PLANS&&a.createElement(xa,{courseId:t,filter:p,keyword:d}))))),a.createElement(Ht,{mode:Ve.ADD,open:o,onClose:()=>n(!1),courseId:t}))};var Fa=m.exports.memo(va);const wa=e=>{const{courseId:t}=e,o=B(),n=w(x.COURSES),{data:r,isLoading:s,refetch:i}=Y({entity:"location",action:"lessonLocationIdsByCourseId"})({course:t},{enabled:Boolean(t),selector(g){return g&&P(g)?g.map(C=>C.location_id):[]},onError(g){U.warn("useGetCourseLocation fetch location ids",g),o(n("unableToGetLocationIds"),"error")}}),c=P(r),{data:d,isLoading:l,refetch:p}=Y({entity:"location",action:"lessonLocationGetMany"})({location_ids:r},{enabled:c,onError(g){U.warn("useGetCourseLocation fetch locations",g),o(n("unableToGetLocation"),"error")}});return{locationIds:r,locations:c?d:[],isLoading:s||l,updateCourseLocations:async()=>{Boolean(t)&&await i(),Boolean(r)&&await p()}}},ve={tabs:e=>{var t;return{border:`1px solid ${e.palette.divider}`,borderRadius:`${e.shape.borderRadius}px`,background:(t=e.palette.other)==null?void 0:t.backgroundLight,"& > hr":{display:"none"}}},tabPanel:e=>({border:`1px solid ${e.palette.divider}`,borderTop:0,borderRadius:`${e.shape.borderRadius}px`})},ss=()=>{const{id:e}=Nt(),{open:t,onOpen:o,onClose:n}=Qt(),r=B(),{data:s,isLoading:i,refetch:c}=Y({entity:"courses",action:"lessonCourseGetOne"})({course_id:e},{enabled:Boolean(e),onError:R=>{U.warn("lessonCourseGetOne",R),r("ra.message.unableToLoadData","error")}}),d=I(),l=w(x.COURSES),p=w(x.CLASS),{onEdit:y,isLoading:g}=Gt({isEdit:!0}),{isEnabled:C}=ue(de.STUDY_PLAN_MANAGEMENT),{isEnabled:b}=ue(de.LESSON_COURSE_MANAGEMENT_CLASS_MANAGEMENT),{locationIds:E,locations:u,isLoading:S,updateCourseLocations:h}=wa({courseId:s==null?void 0:s.course_id}),_=P(E)&&u,T=m.exports.useMemo(()=>_?u.map(({location_id:R,name:ne})=>({locationId:R,name:ne})):[],[_,u]),D=m.exports.useMemo(()=>s!=null&&s.teaching_method?{id:Number(Pt.CourseTeachingMethod[s==null?void 0:s.teaching_method]),name:d(`resources.choices.teachingMethod.${s==null?void 0:s.teaching_method}`)}:void 0,[s,d]),L=async R=>{const{name:ne,iconFile:Qe,iconUrl:We,locations:re,teachingMethod:le}=R,je=re==null?void 0:re.map(ie=>ie.locationId);N(""),await y({name:ne,course_id:s==null?void 0:s.course_id,files:Qe,icon:We,locationIdsList:je,teachingMethod:le==null?void 0:le.id},{onSuccess:()=>{c().finally(()=>h()).finally(()=>n())},onError:ie=>{ie.message==wt.ALREADY_EXISTS&&N(l("locationAlreadyExists"))}})},A=()=>{n(),N("")},[O,N]=m.exports.useState("");if(i||!s||S)return a.createElement(Fe,null);const v=s.name,K=[...kt.can("lesson_groups","list")?[{tabName:a.createElement(q,{label:l("lesson"),"data-testid":"CourseShow__lessonTab"}),tabPanel:a.createElement(oa,{courseId:e})}]:[],...C?[{tabName:a.createElement(q,{label:l("studyPlan.title"),"data-testid":"CourseShow__studyPlanTab"}),tabPanel:a.createElement(Fa,{courseId:e})}]:[],{tabName:a.createElement(q,{label:l("settings"),"data-testid":"CourseShow__settingTab"}),tabPanel:a.createElement(da,{course:s,refetch:()=>{c(),h()},locations:u||[],isLoadingLocation:S})},...b?[{tabName:a.createElement(q,{label:p("class"),"data-testid":"CourseShow__classTab"}),tabPanel:a.createElement(ha,{courseId:e})}]:[]];return a.createElement(a.Fragment,null,t&&a.createElement(Vt,{mode:Ve.EDIT,onClose:A,open:t,errorMessage:O,loading:g,onSave:L,defaultValues:{name:v,iconUrl:s.icon||void 0,locations:T,teachingMethod:D}}),a.createElement(f,{pb:3},a.createElement(xt,null,a.createElement(vt,{title:v,action:a.createElement(la,{recordId:e,onEdit:o,recordName:v}),width:"100%"}),a.createElement(V,{item:!0,xs:12,"data-testid":"CourseShow__tab"},a.createElement(Ft,{tabsSx:ve.tabs,tabPanelSx:ve.tabPanel,mapTabs:K,customOptions:{updateInQuery:!0},showCustomTestId:!0,addTabNameToQuery:!0})))))};export{ss as default};
