var X=Object.defineProperty,J=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var U=(e,t,o)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,h=(e,t)=>{for(var o in t||(t={}))N.call(t,o)&&U(e,o,t[o]);if(y)for(var o of y(t))w.call(t,o)&&U(e,o,t[o]);return e},L=(e,t)=>J(e,Y(t));var S=(e,t)=>{var o={};for(var a in e)N.call(e,a)&&t.indexOf(a)<0&&(o[a]=e[a]);if(e!=null&&y)for(var a of y(e))t.indexOf(a)<0&&w.call(e,a)&&(o[a]=e[a]);return o};import{r as E,eG as Z,R as s,hj as ee,aK as te,cV as A,eO as oe,dQ as ae,aS as O,aj as M,eQ as ne,b8 as se,d7 as re,ch as ie,ai as ce,c$ as $,cI as B,e9 as le,ia as de,hG as G,aJ as T,dc as ue,aG as me,cl as he,aH as pe,i8 as ge,ew as Ee,db as Ce,eX as q,hP as P,i9 as fe,cj as Le}from"./index.7daee9ef.js";import{A as xe}from"./AvatarInputHF.36ed1c41.js";import{i as be}from"./infer-query.264ca744.js";import{v as _e,r as W,x as R,u as F,y as j,w as V}from"./useShowSnackbar.da46e481.js";import{u as Ie}from"./useSafeState.fc2ddfd3.js";import{u as Se}from"./useBasicContent.160dc809.js";import{u as Te}from"./useNotifyForm.ee77e08e.js";function ke(e){const m=e,{keyShowValue:t,checked:o,indeterminate:a,option:n,sxCheckbox:r,sxText:i}=m,c=S(m,["keyShowValue","checked","indeterminate","option","sxCheckbox","sxText"]);return s.createElement(s.Fragment,null,s.createElement(ee,h({"data-testid":"ItemLocation__checkbox",variant:"selector",checked:o,indeterminate:a,sx:r},c)),s.createElement(te,{variant:"body2","data-testid":"ItemLocation__label",sx:i},n&&n[t]))}var ye=E.exports.memo(ke,(e,t)=>Z(e,t));function K(e){var a;const{node:t,result:o=[]}=e;if((a=t.children)!=null&&a.length||o.push(t),t!=null&&t.children)for(const n of t.children)K({node:n,result:o});return o}function ve(e){const{keyCompareEqual:t,checkedList:o,location:a}=e;return E.exports.useMemo(()=>{const n={indeterminate:!1,checked:!0,selectedLocations:[a],restOfCheckedLocations:[a]};if(A(a.children)){const i=K({node:a}),c=o==null?void 0:o.map(d=>d.locationId),m=i.filter(d=>!(c!=null&&c.includes(d.locationId))),p=m.length,l=i.length,u={selectedLocations:i,restOfCheckedLocations:m};if(p===0)return h(h({},n),u);if(p===l)return h(L(h({},n),{checked:!1}),u);if(p<l)return h({indeterminate:!0,checked:!1},u)}const r=o==null?void 0:o.findIndex(i=>i[t]===a[t]);return L(h({},n),{checked:r!==-1})},[o,t,a])}function Me(e){const d=e,{option:t,keyCompareEqual:o,checkedList:a,onCheck:n,sxItem:r}=d,i=S(d,["option","keyCompareEqual","checkedList","onCheck","sxItem"]),{checked:c,restOfCheckedLocations:m,indeterminate:p,selectedLocations:l}=ve({keyCompareEqual:o,checkedList:a,location:t}),u=()=>{n(l,m,c)};return s.createElement(oe,{button:!0,dense:!0,disableGutters:!0,style:{marginLeft:t.level?t.level*24:0},onClick:u,"data-testid":"ItemLocation__container","data-value":t&&t[o],"data-type":A(t.children)?"parent":"child",sx:r},s.createElement(ye,h({option:t,indeterminate:p,checked:c},i)))}const Oe=e=>{var o;const t=(o=e.children)==null?void 0:o.filter(a=>a.disabled!==!0);return(t==null?void 0:t.length)===0};function z(e,t=3,o={locationId:"",name:"",locationType:"",parentLocationId:"",accessPath:""}){var a,n,r;if(e.level<t&&((a=e.children)==null?void 0:a.length)===0&&((n=o.children)==null||n.forEach(i=>{i.locationId===e.locationId&&Object.assign(e,L(h({},e),{disabled:!0}))}),Oe(o)&&Object.assign(o,L(h({},o),{disabled:!0}))),e.children&&((r=e.children)==null?void 0:r.length)!==0)for(const i of e.children)z(i,t,e);return e}const Fe=e=>{const t=new Map,o=[];let a=0;return e.forEach((n,r)=>{t.set(n.locationId,r),n.children=[]}),e.forEach(n=>{if(n.parentLocationId==="")return o.push(n);const r=t.get(n.parentLocationId)||0,i=n.accessPath.split("/").length-1;i>a&&(a=i),e[r].children.push(L(h({},n),{level:i}))}),{roots:o,maxLevel:a}};function De(){const e=_e(),t=W(),{isLoading:o,data:a}=be({entity:"masterReader",action:"masterReaderGetLocation"})(void 0,{enabled:!0,onError:n=>{const r=ae(n);e(t(r.message),"error"),R.warn("Get locations was fail",r)},selector:n=>{const{roots:r,maxLevel:i}=Fe(n);return z(r[0],i).children||[]}});return{treeLocations:a||[],isLoading:o}}const v={dialogContent:e=>{var t;return{borderStyle:"solid",borderWidth:1,borderColor:(t=e.palette.border)==null?void 0:t.main,marginTop:e.spacing(1.4),borderRadius:e.spacing(.5),padding:e.spacing(1.5),height:"100%",maxHeight:`calc(100vh - ${e.spacing(38)})`,overflow:"auto"}},itemLocation:e=>({display:"flex",alignItems:"center",marginTop:e.spacing(1),marginBottom:e.spacing(1),width:"90%"}),textLabel:e=>({marginLeft:e.spacing(.5)}),checkbox:e=>({paddingLeft:e.spacing(.5)})};function Re(e){const b=e,{onAdd:t,initialCheckedList:o}=b,a=S(b,["onAdd","initialCheckedList"]),n=F(O.COURSES),{treeLocations:r,isLoading:i}=De(),[c,m]=Ie(o||[]),p=()=>{t&&t(c)},l=E.exports.useCallback((C,x,g)=>{if(!g){m([...c,...x]);return}const _=C.map(I=>I.locationId),f=c.filter(I=>!_.includes(I.locationId));m(f)},[c,m]),u=E.exports.useCallback(()=>{const C=c.filter(_=>!_.isArchived),x=C.slice(0,5),g=C.length-5;return s.createElement(M,{pt:3},s.createElement(ne,{variant:"body2","data-testid":"DialogTreeLocations__subNote"},`${n("labels.selected")}: ${x.map(_=>" "+_.name)}${g>0?", +"+g:""}`))},[c,n]),d=()=>{if(i)return s.createElement(re,null);if(!A(r))return null;const C=x=>s.createElement(s.Fragment,null,x.map(g=>s.createElement(E.exports.Fragment,{key:g.locationId},!g.disabled&&s.createElement(Me,{size:"small",color:"primary",option:g,onCheck:l,keyShowValue:"name",keyCompareEqual:"locationId",checkedList:c,sxItem:v.itemLocation,sxText:v.textLabel,sxCheckbox:v.checkbox}),g.children&&C(g.children))));return s.createElement(M,{sx:v.dialogContent,"data-testid":"DialogTreeLocations__tree"},C(r))};return s.createElement(se,L(h({},a),{onSave:p,fullWidth:!0,maxWidth:"md",maxWidthBox:"md","data-testid":"DialogTreeLocations"}),d(),u())}const D={tagBox:e=>({padding:e.spacing(.25)}),tag:e=>({backgroundColor:"transparent",border:`1px solid ${e.palette.grey[300]}`}),limitTag:e=>({backgroundColor:e.palette.grey[200]})},Ae=e=>{const _=e,{name:t,limitTags:o=10,titleDialog:a,rules:n}=_,r=S(_,["name","limitTags","titleDialog","rules"]),{control:i,setValue:c,getValues:m}=ie(),[p,l]=E.exports.useState(m(t)),[u,d]=ce(!1),b=f=>{l(f),c(t,f),d(!1)},{isEnabled:C}=j($.LESSON_COURSE_MANAGEMENT_REMOVE_COURSE_LOCATION),x=E.exports.useCallback(f=>f.map((I,k)=>s.createElement(M,{key:k,sx:D.tagBox,maxWidth:"100%","data-testid":"LocationSelectInputHF__tagBox"},s.createElement(B,{"data-testid":"LocationSelectInputHF__ChipTag",size:"small",sx:D.tag,label:I.name}))),[]),g=E.exports.useCallback(f=>s.createElement(B,{"data-testid":"LocationSelectInputHF__chipLimitTags",size:"small",sx:D.limitTag,label:`+ ${f}`}),[]);return s.createElement(le,{control:i,name:t,rules:n,render:({formState:{errors:f}})=>{var I,k;return s.createElement(s.Fragment,null,s.createElement(de,L(h({},r),{freeSolo:!0,multiple:!0,id:"LocationSelectInputHF__root","data-testid":"LocationSelectInputHF__root",optionLabelKey:"name",disableClearable:!C,limitTags:o,options:[],value:p||[],onOpen:()=>{d(!0)},onChange:(H,Ne,Q)=>{Q==="clear"&&b([])},onKeyDown:H=>{H.preventDefault()},renderTags:x,getLimitTagsText:g,PopperComponent:()=>null,error:Boolean((I=f[t])==null?void 0:I.message),helperText:(k=f[t])==null?void 0:k.message})),u&&s.createElement(Re,{initialCheckedList:p,open:u,onClose:()=>d(!1),onAdd:b,title:a}))}})},He=e=>[{id:G.CourseTeachingMethod.COURSE_TEACHING_METHOD_INDIVIDUAL,name:e("resources.choices.teachingMethod.COURSE_TEACHING_METHOD_INDIVIDUAL")},{id:G.CourseTeachingMethod.COURSE_TEACHING_METHOD_GROUP,name:e("resources.choices.teachingMethod.COURSE_TEACHING_METHOD_GROUP")}],Ue=({isEditMode:e,defaultTeachingMethod:t})=>{const o=W(),a=F(O.COURSES),{isEnabled:n}=j($.LESSON_COURSE_BACK_OFFICE_TEACHING_METHOD),r={name:{required:{value:!0,message:o("resources.input.error.required")}},locations:{required:{value:!0,message:o("resources.input.error.required")}},teachingMethod:{required:{value:!0,message:o("resources.input.error.required")}}},i=He(o);return s.createElement(T,{container:!0,spacing:2,"data-testid":"CourseForm__root"},s.createElement(T,{item:!0,xs:12,container:!0,justifyContent:"center"},s.createElement(xe,{shouldDelete:!0,name:"iconFile",initialSource:"iconUrl",mode:"files"})),s.createElement(T,{item:!0,xs:12},s.createElement(M,{py:1},s.createElement(ue,null))),s.createElement(T,{item:!0,xs:12},s.createElement(me,{autoFocus:!0,required:!0,id:"name",label:a("courseName"),name:"name",rules:r.name})),s.createElement(T,{item:!0,xs:12},s.createElement(Ae,{label:a("location"),name:"locations",getOptionSelectedField:"locationId",titleDialog:a("dialogSelectLocationTitle"),rules:n?r.locations:{},required:n})),n&&s.createElement(T,{item:!0,xs:12},s.createElement(he,{id:"TeachingMethodAutocompleteHF__autocomplete",name:"teachingMethod","data-testid":"TeachingMethodAutocompleteHF__autocomplete",key:"teachingMethod",label:a("teachingMethod"),options:i,getOptionSelectedField:"id",optionLabelKey:"name",rules:r.teachingMethod,required:!0,disabled:e&&Boolean(t),sx:c=>({paddingBottom:c.spacing(1)})})))},je=e=>{const t=F(O.COURSES),g=e,{defaultValues:o,mode:a,loading:n,onClose:r,onSave:i,errorMessage:c}=g,m=S(g,["defaultValues","mode","loading","onClose","onSave","errorMessage"]),p=pe({defaultValues:o}),{handleSubmit:l,setError:u,clearErrors:d}=p,b=a===ge.EDIT,C=t("addCourse"),x=b?t("editTitle"):C;return E.exports.useEffect(()=>{c&&c!==""?u("locations",{message:c}):d("locations")},[c,u,d]),s.createElement(Ee,h({title:x,onClose:r,onSave:l(i),methods:p,footerConfirmButtonProps:{disabled:n},contentSize:"medium"},m),s.createElement(Ce,null,s.createElement(Ue,{isEditMode:b,defaultTeachingMethod:o==null?void 0:o.teachingMethod})))},Ke=({isEdit:e}={})=>{const t=F(O.COURSES),{school_id:o}=Se(),a=Te({action:e?q.EDIT:q.CREATE,entityName:t("name")}),{mutate:n,isLoading:r}=V({entity:"coursesMaster",action:"courseCreate"})({onSuccess:()=>{a(P.SUCCESS,{})},onError:l=>{R.warn("useUpsertCourse",l),l.message!=fe.ALREADY_EXISTS&&a(P.FAILURE,{})}}),{mutateAsync:i}=V({entity:"media",action:"UPLOAD_MEDIA"})({onError:l=>{R.warn("useUpsertCourse upload Files",l)}}),c=E.exports.useCallback(async l=>{var d;const u=await i({files:l});return(d=Le(u))==null?void 0:d.gRPC.downloadUrl},[i]),m=E.exports.useCallback(async(l,u)=>{const d=l.files?await c(l.files):void 0;n(L(h({},l),{chapter_ids:[],icon:d,display_order:1,school_id:o}),u)},[c,n,o]),p=E.exports.useCallback(async(l,u)=>{l.files&&(l.icon=await c(l.files)),n(L(h({},l),{school_id:o,chapter_ids:[],display_order:1}),u)},[c,n,o]);return{onCreate:m,onEdit:p,isLoading:r}};export{je as D,Ke as u};
