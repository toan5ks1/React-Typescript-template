var oe=Object.defineProperty,re=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var Y=(t,e,s)=>e in t?oe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,T=(t,e)=>{for(var s in e||(e={}))j.call(e,s)&&Y(t,s,e[s]);if(R)for(var s of R(e))w.call(e,s)&&Y(t,s,e[s]);return t},L=(t,e)=>re(t,ne(e));var q=(t,e)=>{var s={};for(var a in t)j.call(t,a)&&e.indexOf(a)<0&&(s[a]=t[a]);if(t!=null&&R)for(var a of R(t))e.indexOf(a)<0&&w.call(t,a)&&(s[a]=t[a]);return s};import{df as W,hl as V,cV as x,eC as A,cG as D,r as p,cZ as ue,cR as O,d$ as ce,e0 as de,R as S,cl as le,aS as X,eb as ie,aj as K,aJ as F,aG as me,et as ye,hN as Se,i8 as pe,hL as Pe,aH as ge,d0 as Ee,ci as fe,ew as be,cN as z,ib as J,cv as Te}from"./index.7daee9ef.js";import{u as _e}from"./useNavigation.f38e637f.js";import{D as ke,r as ee,v as Ae,w as U,x as v,u as te}from"./useShowSnackbar.da46e481.js";import{u as he}from"./useBasicContent.160dc809.js";import{i as Ce}from"./infer-query.264ca744.js";import{a as ve}from"./display-order.ffc5e670.js";const Ve={grades:[],books:[],archived:!1},De={name:"",book:null,grades:[],trackSchoolProgress:!1},Ye=/^(\d{4}\/\d{2}\/\d{2})$/,je=/^(\d{4}\/\d{2}\/\d{2},\s\d{2}:\d{2})$/,$=W(V.StudyPlanStatus),we=W(ke.StudyPlanItemStatus),Ie=(t={})=>{const{translate:e}=t,s=ee(),a=c=>e?e(c):s(`resources.choices.grades.${c}`),r=c=>c.map(d=>a(d));return{convertGradeToArrayString:r,convertGradeToString:(c,d=", ")=>r(c).join(d),convertGradesToArrayGradeObject:c=>x(c)?c.map(d=>({id:d,name:a(d)})):[],convertGradeObjectsToArrayNumber:c=>x(c)?c.map(d=>d.id):[]}},Re=t=>{const{action:e,courseId:s,studyPlanId:a}=t,r=Ae(),{school_id:l}=he(),{convertGradeObjectsToArrayNumber:n}=Ie(),{mutate:u,isLoading:c}=U({entity:"book",action:"BOOK_ADD_TO_COURSE"})({syllabusMigrationQuery:{delay:3e3},onError:o=>{v.error("add book to course failed",o),r("resources.courses.studyPlan.messages.error.addBook",A.ERROR)}}),{mutate:d,isLoading:i}=U({entity:"studyPlan",action:"STUDY_PLAN_UPSERT"})({onSuccess:()=>{const o=e===D.CREATE?"resources.courses.studyPlan.messages.success.addedStudyPlan":"resources.courses.studyPlan.messages.success.editedStudyPlan";r(o,A.SUCCESS)},onError:o=>{v.error(`${e} study plan failed`,o);const m=e===D.CREATE?"resources.courses.studyPlan.messages.error.addStudyPlan":"resources.courses.studyPlan.messages.error.editStudyPlan";r(m,A.ERROR)}}),{mutate:P,isLoading:g}=U({entity:"studyPlan",action:"STUDY_PLAN_UPSERT"})({onSuccess:()=>{r("resources.courses.studyPlan.messages.success.archivedStudyPlan",A.SUCCESS)},onError:o=>{v.error("archive study plan failed",o),r("resources.courses.studyPlan.messages.error.archiveStudyPlan",A.ERROR)}}),{mutate:_,isLoading:f}=U({entity:"studyPlan",action:"STUDY_PLAN_UPSERT"})({onSuccess:()=>{r("resources.courses.studyPlan.messages.success.unarchivedStudyPlan",A.SUCCESS)},onError:o=>{v.error("unarchive study plan failed",o),r("resources.courses.studyPlan.messages.error.unarchiveStudyPlan",A.ERROR)}}),b=p.exports.useCallback(o=>{const{name:m,book:y,grades:k,trackSchoolProgress:C}=o,M={courseId:s,bookIdsList:ue(y.book_id)},G=V.StudyPlanStatus[$.STUDY_PLAN_STATUS_ACTIVE],H={name:m.trim(),bookId:y.book_id,gradesList:n(k),schoolId:l,courseId:s,trackSchoolProgress:C,status:G},se=T({studyPlanId:{value:a}},H),ae=e===D.CREATE?H:se;return{payloadBook:M,payloadStudyPlan:ae}},[e,n,s,l,a]),E=p.exports.useCallback((o,m)=>{const{name:y,book_id:k,grades:C,track_school_progress:M,course_id:G}=o;return{studyPlanId:{value:a},name:O(y),bookId:O(k),gradesList:x(C)?C:[],schoolId:l,courseId:O(G),trackSchoolProgress:!!M,status:V.StudyPlanStatus[m]}},[l,a]),h=p.exports.useCallback((o,m)=>{if(c||i)return;const{payloadBook:y,payloadStudyPlan:k}=b(o);u(y,{onSuccess:()=>{d(k,m)}})},[c,i,b,u,d]),B=p.exports.useCallback((o,m)=>{if(i)return;const{payloadStudyPlan:y}=b(o);d(y,m)},[i,b,d]),I=p.exports.useCallback((o,m)=>{if(g)return;const y=E(o,$.STUDY_PLAN_STATUS_ARCHIVED);P(y,m)},[g,E,P]),N=p.exports.useCallback((o,m)=>{if(f)return;const y=E(o,$.STUDY_PLAN_STATUS_ACTIVE);_(y,m)},[f,E,_]);return{createStudyPlan:h,updateStudyPlan:B,archiveStudyPlan:I,activateStudyPlan:N,isLoadingBookMutation:c,isLoadingStudyPlanMutation:i,isLoadingStudyPlanArchive:g,isLoadingStudyPlanActivation:f}},Le=({entity:t,action:e,params:s,selector:a,onSuccess:r,onError:l})=>{const[n,u]=p.exports.useState(""),c=p.exports.useMemo(()=>ce(u,de),[u]),d=p.exports.useMemo(()=>s(n),[n,s]),{isFetching:i,data:P=[]}=Ce({entity:t,action:e})(T({},typeof d=="object"?d:{}),{enabled:!0,onSuccess:r,selector:a,onError:g=>{v.warn(`[useAutocompleteReference] ${t}-${e}`,g),l&&l(g)}});return{isFetching:i,options:P,setInputVal:c}},Fe=i=>{var P=i,{optionLabelKey:t="name",multiple:e=!0,name:s,entity:a,action:r,onInputChange:l,params:n,selector:u,onError:c}=P,d=q(P,["optionLabelKey","multiple","name","entity","action","onInputChange","params","selector","onError"]);const{isFetching:g,options:_,setInputVal:f}=Le({entity:a,action:r,params:n,selector:u,onError:c});return S.createElement(le,L(T({"data-testid":"AutocompleteReferenceHF"},d),{name:s,multiple:e,loading:g,optionLabelKey:t,options:_,onInputChange:(b,E,h)=>{f(E),l&&l(b,E,h)},filterSelectedOptions:!0}))},Ue=t=>S.createElement(Fe,T({entity:"book",action:"syllabusBookGetManyReference","data-testid":"BooksAutocompleteHF__autocomplete",params:e=>({limit:10,offset:0,name:e}),selector:e=>e?e.map(s=>T({value:s.name},s)):[]},t)),Oe=t=>{const{isAddMode:e}=t,s=ee(),a=te(X.COURSES);return S.createElement(ie,{"data-testid":"StudyPlanForm__root"},S.createElement(K,{pt:3,p:4},S.createElement(F,{container:!0,spacing:2},S.createElement(F,{item:!0,xs:6},S.createElement(Ue,{required:!0,name:"book",label:a("studyPlan.bookAssociation"),multiple:!1,rules:{required:s("resources.input.error.required")},disabled:!e,limitChipText:"Ellipsis",getOptionSelectedField:"book_id"})),S.createElement(F,{item:!0,xs:6},S.createElement(me,{name:"name",label:a("studyPlan.studyPlanName"),required:!0,rules:{required:s("resources.input.error.required")},"data-testid":"StudyPlanForm__studyPlanName"})),S.createElement(F,{item:!0,xs:12},S.createElement(ye,{label:a("grade"),name:"grades",disableCloseOnSelect:!0,filterSelectedOptions:!0,multiple:!0,getOptionSelectedField:"id"}))),S.createElement(K,{mt:2,display:"flex"},S.createElement(Se,{name:"trackSchoolProgress",label:a("studyPlan.trackSchoolProgressCheckbox"),"data-testid":"StudyPlanForm__trackSchoolProgress",disableMarginLeft:!0,checkBoxProps:{variant:"selector",size:"small",name:"trackSchoolProgress"}}))))},qe=t=>{const{open:e,onClose:s,defaultValues:a=De,courseId:r,studyPlanId:l,mode:n,refetchStudyPlanInfo:u}=t,c=te(X.COURSES),d=_e(),i=n===pe.ADD,P=`?${Pe.COURSE_ID}=${r}`,g=c(i?"studyPlan.addStudyplan":"studyPlan.editStudyplan"),{createStudyPlan:_,updateStudyPlan:f,isLoadingBookMutation:b,isLoadingStudyPlanMutation:E}=Re({action:i?D.CREATE:D.UPDATE,courseId:r,studyPlanId:l}),h=ge({defaultValues:a}),{handleSubmit:B,reset:I,formState:{isDirty:N}}=h,o=p.exports.useCallback(()=>{s()},[s]),m=p.exports.useCallback(y=>i?_(y,{onSuccess:async k=>{const{studyPlanId:C}=await k;d.push(`/${Ee.SYLLABUS}/${fe.STUDY_PLANS}/${C}/show${P}`)}}):f(y,{onSuccess:()=>{u&&u(),o()}}),[_,o,i,d,u,P,f]);return p.exports.useEffect(()=>{e&&I(a)},[e,JSON.stringify(a),I]),S.createElement(be,{title:g,open:e,onClose:o,onSave:B(m),methods:h,footerConfirmButtonProps:{disabled:b||E||!N},"data-testid":"DialogUpsertStudyplan__root",contentSize:"medium"},S.createElement(Oe,{isAddMode:i}))},Q=t=>{const e=t;return e.assignment_id?e.assignment_id:t.lo_id},Z=t=>{const e=t;return e.content?e.content.topic_id:O(t.topic_id)},Ke=({topics:t,assignments:e,learningObjectives:s,studyPlanItemsByAssignmentId:a,studyPlanItemsByLoId:r})=>{const l=[...e,...s].reduce((n,u)=>L(T({},n),{[Z(u)]:[...n[Z(u)]||[],L(T({},a[Q(u)]||r[Q(u)]),{loName:u.name,loType:u.type,display_order:u.display_order})]}),{});return t.map(({info:n})=>({topicId:n.id,topicName:n.name,studyPlanItems:(l[n.id]||[]).sort(ve)})).filter(({studyPlanItems:n})=>x(n))},ze=({isoDate:t,timezone:e,withYear:s})=>{if(!t)return"";const a="LL/dd, HH:mm",r="yyyy/LL/dd, HH:mm",l=z(J(new Date,e.value)),n=z(J(t,e.value));let u=n.getFullYear()===l.getFullYear()?a:r;return s&&(u=r),Te(n,u)},Je=({studentList:t,studyPlanList:e})=>t.map(({user_id:s,name:a})=>{const r=e.filter(({studentId:n})=>n===s);return{studentId:s,studentName:a,studyPlanList:r}});export{Ue as B,qe as D,$ as S,Re as a,je as b,we as c,Ye as d,Ke as e,ze as f,Je as g,Ve as s,Ie as u};
