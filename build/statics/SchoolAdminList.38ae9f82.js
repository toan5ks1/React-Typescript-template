var Q=Object.defineProperty,G=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var U=(a,e,t)=>e in a?Q(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,h=(a,e)=>{for(var t in e||(e={}))V.call(e,t)&&U(a,t,e[t]);if(I)for(var t of I(e))k.call(e,t)&&U(a,t,e[t]);return a},g=(a,e)=>G(a,W(e));var M=(a,e)=>{var t={};for(var n in a)V.call(a,n)&&e.indexOf(n)<0&&(t[n]=a[n]);if(a!=null&&I)for(var n of I(a))e.indexOf(n)<0&&k.call(a,n)&&(t[n]=a[n]);return t};import{aU as Y,r as S,b$ as j,c0 as J,cH as B,cZ as X,cG as T,aS as f,aW as Z,aV as z,hd as p,he as ee,d$ as K,cd as ae,dN as te,aH as re,R as u,ew as ne,db as ce,aJ as L,aG as P,cQ as se,hf as ue,aK as N,d5 as le,d6 as ie,bb as de,aj as oe,gA as me,hg as fe,g2 as he,cm as _e}from"./index.7daee9ef.js";import{u as Se,a as v,b as Ee,c as ye}from"./usePagination.d47dd214.js";var R=(a=>(a[a.RETRY_TIMES=0]="RETRY_TIMES",a[a.CACHE_TIME=0]="CACHE_TIME",a[a.TIME_UNTIL_AUTO_REFETCH=3e5]="TIME_UNTIL_AUTO_REFETCH",a))(R||{});function q(a){return`${a.entity}_${a.action}`}const ge=Y(0);function be(){const[a=0,e]=ge();return{version:a,reload:S.exports.useCallback(()=>e(a+1),[e,a])}}function H(a,e){var i,s,d;const t=B(),{version:n}=be(),c=q(a),r={request:a,version:n},l=typeof(e==null?void 0:e.enabled)=="undefined"?!0:e==null?void 0:e.enabled;return h({queryKey:[c,r]},j([q(a),r],async _=>{var m;try{return await t[a.action](a.entity,a.params)}catch(o){const E=J(_.queryKey);throw(m=window.warner)==null||m.warn(`UseQuery ${E}`,o),o}},{enabled:l,cacheTime:(i=e==null?void 0:e.cacheFor)!=null?i:R.CACHE_TIME,staleTime:(s=e==null?void 0:e.markDataAsStaleAfter)!=null?s:R.TIME_UNTIL_AUTO_REFETCH,select:e==null?void 0:e.selector,retry:(d=e==null?void 0:e.retry)!=null?d:R.RETRY_TIMES,notifyOnChangeProps:e==null?void 0:e.rerenderOnChangeProps,keepPreviousData:!0,refetchOnWindowFocus:!1,onError:e==null?void 0:e.onError,onSuccess:e==null?void 0:e.onSuccess}))}function Ce(a){return X(a.data)[0]}function Ae(a,e,t){return H({entity:a,action:T.ONE,params:{filter:{entityId:e}}},g(h({},t),{selector:n=>{var r;const c=Ce(n);return t&&t.selector?(r=t==null?void 0:t.selector)==null?void 0:r.call(t,c):c}}))}function Te(a){const{data:e}=Ae(f.SCHOOLS,a);return e}function Oe(a,e){const t=B(),n=z();return Z(async c=>(await t[a.action](a.entity,c)).data,g(h({},e),{onMutate:e==null?void 0:e.onBeforeMutate,onSuccess:async(c,r,l)=>{var i;e!=null&&e.invalidateKey&&await n.invalidateQueries(e==null?void 0:e.invalidateKey),await((i=e==null?void 0:e.onSuccess)==null?void 0:i.call(e,c,r,l))}}))}function Ie(){return{fetchQuery:p}}const Le=()=>{const a=Se(ae.STUDENTS),e=v(),t=a("descriptions.email"),n=a("descriptions.phoneNumber"),{fetchQuery:c}=Ie(),r=async s=>{const d=await c({action:T.ONE,entity:f.USERS,params:{filter:h({},s)}});return!!(d.data&&d.data.user_id)},l=async s=>{if(await r({email:s}))return a("messages.error.exited",{field:t})},i=async s=>{if(!!s&&await r({phone_number:s}))return a("messages.error.exited",{field:n})};return{required:{value:!0,message:e("resources.input.error.required")},pattern:{email:{value:ee,message:a("messages.error.invalid",{field:t})}},validate:{email:K(l,500,{leading:!0}),phone:i}}},Re=a=>{const{onClose:e,onSave:t,open:n}=a,c=Te(Number(a.schoolId)),r=v(),l=Ee(),i={school_id:Number(a.schoolId),country:c==null?void 0:c.country,user_group:te.UserGroup.USER_GROUP_SCHOOL_ADMIN,name:"",current_grade:0,phone_number:"",email:""},s=re({defaultValues:i,mode:"all"}),{handleSubmit:d,formState:{isDirty:_},watch:m}=s,o=Le(),E=m("name"),b=m("phone_number"),C=m("email"),{mutate:A,isLoading:F}=Oe({entity:f.SCHOOL_ADMINS,action:T.CREATE}),x=async y=>{const $={user:{name:y.name,email:y.email,phone_number:y.phone_number},current_grade:0,country:c==null?void 0:c.country,user_group:y.user_group,school_id:Number(y.school_id)};A({data:$},{onSuccess:()=>{l(`${r("ra.common.createdSuccess",{smart_count:r("resources.schools.detail.createAccount.entityName")},{lowercase:!0})}`),t==null||t()},onError:w=>{var D;l(w.message?r(w.message):r("ra.manabie-error.unknown"),"error"),(D=window.warner)==null||D.warn("onError createAccountSchool",w)}})},O=F||!_||!E||!C||!b;return u.createElement(ne,{title:r("resources.schools.detail.createAccount.title"),open:n,onClose:e,onSave:d(x),methods:s,footerConfirmButtonProps:{disabled:O}},u.createElement(ce,null,u.createElement(L,{container:!0,spacing:3},u.createElement(L,{item:!0,sm:6},u.createElement(P,{inputProps:{"data-testid":"CreateAccount__name"},required:!0,label:r("resources.schools.detail.admin.name"),name:"name",rules:{required:o.required}})),u.createElement(L,{item:!0,sm:6},u.createElement(P,{inputProps:{"data-testid":"CreateAccount__phone"},required:!0,name:"phone_number",label:r("resources.schools.detail.admin.phone"),rules:{required:o.required,validate:o.validate.phone}})),u.createElement(L,{item:!0,sm:6},u.createElement(P,{inputProps:{"data-testid":"CreateAccount__email"},required:!0,label:r("resources.schools.detail.admin.email"),name:"email",rules:{required:o.required,pattern:o.pattern.email,validate:K(o.validate.email,500,{leading:!0})}})))))};function ve(a,e){return g(h({},a),{pagination:{limit:e.limit,offset:e.offset}})}function we(a,e={}){var _;const d=e,{defaultOffset:t,defaultLimit:n}=d,c=M(d,["defaultOffset","defaultLimit"]),r=ye({defaultOffset:t,defaultLimit:n}),l=H({action:a.action,entity:a.entity,params:ve(a.params,r)},c),i=S.exports.useMemo(()=>{var C,A;const b=r,{setLimit:m,setOffset:o}=b,E=M(b,["setLimit","setOffset"]);return g(h({},E),{count:(A=(C=l.data)==null?void 0:C.total)!=null?A:0})},[r,l.data]),s=S.exports.useCallback(()=>{r.setOffset(t||0)},[t,r]);return{result:l,data:(_=l.data)==null?void 0:_.data,pagination:i,resetPaginationOffset:s}}function Me(a,e){return H(a,g(h({},e),{selector:t=>{const n=t.data;return e!=null&&e.selector?e==null?void 0:e.selector(n):n}}))}function Pe(a){var O;const e=v(),[t,n]=S.exports.useState(!1),[c,r]=S.exports.useState(""),l={filterValue:c,school_id:a},{result:{isLoading:i,refetch:s},data:d=[],pagination:_,resetPaginationOffset:m}=we({action:T.LIST_WITH_FILTER,entity:f.SCHOOL_ADMINS,params:{filter:l}}),{data:o,isLoading:E,refetch:b}=Me({action:T.COUNT_SCHOOL_ADMINS,entity:f.SCHOOL_ADMINS,params:{filter:l}}),C=E?0:se((O=o==null?void 0:o.users_aggregate.aggregate)==null?void 0:O.count),A=g(h({},_),{count:C});return{translate:e,isCreate:t,setIsCreate:n,handleFilter:y=>{m(),r(y)},pagination:A,data:d,loading:i,refetchSchoolAdminsList:s,resetPaginationOffset:m,handleCreateSuccess:()=>{n(!1),s(),b()}}}const Ne=a=>{const{data:e,loading:t,pagination:n}=a,c=v(),r=ue[f.SCHOOL_ADMINS]||"id",l=S.exports.useMemo(()=>[{key:"colName",title:c(`resources.${f.SCHOOLS}.detail.admin.name`),render:s=>u.createElement(N,{variant:"body2","data-testid":"AccountList__nameColumn"},s.name)},{key:"colPhone",title:c(`resources.${f.SCHOOLS}.detail.admin.phone`),render:s=>s.phone_number?u.createElement(N,{variant:"body2","data-testid":"AccountList__phoneColumn"},s.phone_number):null},{key:"colEmail",title:c(`resources.${f.SCHOOLS}.detail.admin.email`),render:s=>s.email?u.createElement(N,{variant:"body2","data-testid":"AccountList__emailColumn"},s.email):null}],[c]);return u.createElement(le,{body:{rowKey:r,loading:t},data:e,columns:l,tableProps:{"data-testid":"TableSchoolAdmin__table"},footer:{pagination:n},withIndex:!0})},De=()=>{const{id:a}=ie(),{permission:e}=_e(),{translate:t,handleFilter:n,isCreate:c,setIsCreate:r,pagination:l,loading:i,data:s,handleCreateSuccess:d}=Pe(a||"");return u.createElement(S.exports.Fragment,null,u.createElement(de,{title:t(`resources.${f.SCHOOLS}.detail.admin.title`),"data-testid":"TableSchoolAdmin__title"}),c?u.createElement(Re,{open:c,schoolId:a,onSave:d,onClose:()=>r(!1)}):u.createElement(S.exports.Fragment,null,u.createElement(oe,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},u.createElement(me,{onEnterSearchBar:n}),fe(e.currentRole)&&u.createElement(he,{onClick:()=>r(!0),"data-testid":"AccountList__createButton","aria-label":t("resources.schools.detail.createAccount.buttonName")},t("resources.schools.detail.createAccount.buttonName"))),u.createElement(Ne,{data:s,loading:i,pagination:l})))};export{De as default};
